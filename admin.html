<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Mäusegruppe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color:#007aff; --primary-hover-color:#005bb5;
      --background-color:#f4f4f4; --card-background-color:#fff;
      --text-color:#333; --border-radius:12px; --box-shadow:0 4px 10px rgba(0,0,0,.08);
      --font-size-small:14px; --font-size-medium:16px;
      --page-width: 480px;
    }
    /* Mobile-Optimierung: Zentrierung und Max-Breite */
    body{font-family:'SF Pro Display',sans-serif;padding:15px 12px;background:var(--background-color);color:var(--text-color);font-size:var(--font-size-medium);line-height:1.6; display: flex; flex-direction: column; align-items: center;}
    .page-wrap { width: 100%; max-width: var(--page-width); }
    
    h2{font-size:18px;margin:0 0 15px;font-weight:600}
    input[type="text"],input[type="number"],textarea{padding:8px;border:1px solid #ddd;border-radius:8px;font-size:var(--font-size-small);width:100%;box-sizing:border-box}
    textarea{resize:vertical;min-height:80px}
    button{padding:8px 14px;font-size:var(--font-size-small);background:var(--primary-color);color:#fff;border:none;border-radius:10px;cursor:pointer;transition:background-color .2s;font-weight:600;white-space:nowrap}
    button.secondary{background:#f0f0f0;color:#333;border:1px solid #ccc}
    button.secondary:hover{background:#e0e0e0}
    button:hover{background:var(--primary-hover-color)}
    .section{background:var(--card-background-color);padding:15px;margin-bottom:20px;border-radius:var(--border-radius);box-shadow:var(--box-shadow); width: 100%;}
    .liste{margin-top:15px;padding-top:15px;border-top:1px solid #eee}
    .liste>div{padding:10px 0;border-bottom:1px solid #f9f9f9;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .liste>div:last-child{border-bottom:none}
    .delete{color:#ff3b30;cursor:pointer;margin-left:10px;font-weight:600;font-size:var(--font-size-small)}
    .delete:hover{text-decoration:underline}
    .flex{display:flex;align-items:center;gap:10px;padding:8px 0}
    .flex-buttons{display:flex;gap:5px;align-items:center}
    .color-button{border:1px solid #ccc;border-radius:5px;padding:2px 5px;font-size:16px;cursor:pointer;transition:all .2s;background:#fff}
    .color-button:hover{transform:scale(1.1);box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .small-button{padding:4px 8px;font-size:12px;border-radius:8px;background:#fff;color:#333;border:1px solid #ccc}
    .shop-admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .action-buttons{display:flex;gap:5px;flex-grow:1;justify-content:flex-end}
    .action-button{padding:8px 12px;border-radius:8px;border:none;color:#fff;font-weight:600;cursor:pointer;transition:background-color .2s;white-space:nowrap}
    .action-button.execute{background:var(--primary-color)}
    .action-button.execute:hover{background:#005bb5}
    .action-button.white{background:#fff;color:#333;border:1px solid #ccc}
    .action-button.white:hover{background:#f0f0f0}
    .action-button.green{background:#28a745}
    .action-button.green:hover{background:#218838}
    .action-button.red{background:#ef4444}
    .action-button.red:hover{background:#b91c1c}
    .callout{background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;padding:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 100%}
    @media (min-width: 400px) { .row>*{flex:1 1 220px} }
    select,input[type="datetime-local"]{padding:8px;border:1px solid #ddd;border-radius:8px;font-size:var(--font-size-small);width:100%;box-sizing:border-box}

    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px; width: 100%;}
    .mode-wrap{display:flex;align-items:center;gap:10px}
    .mode-cycle{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #ccc;color:#111;border-radius:999px;padding:6px 10px}
    .mode-dot{width:12px;height:12px;border-radius:50%}
    .dot-green{background:#16a34a}.dot-yellow{background:#f59e0b}.dot-red{background:#ef4444}
    .mode-text{font-weight:700;font-size:14px}
    .title{font-size:22px;font-weight:600;color:var(--primary-color);margin-left:auto}

    /* Modal Styles */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:var(--card-background-color);padding:20px;border-radius:var(--border-radius);width:90%;max-width:400px;box-shadow:var(--box-shadow);z-index:1001}
    .modal-content h3{margin-top:0;font-size:20px}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:600;font-size:var(--font-size-small)}
    .modal-actions{display:flex;justify-content:space-between;margin-top:20px;gap:10px}
    .modal-actions button{flex:1 1 0}
    .modal-actions button.full{flex:1 1 100%}
    .modal-actions .red{background:#ef4444}
    .modal-actions .red:hover{background:#b91c1c}
    .modal-actions .secondary{background:#f0f0f0;color:#333}

    /* Sperr-Anzeige */
    .kontostatus{font-weight:600;margin-bottom:10px}
    .kontostatus.gesperrt{color:#ef4444}
    .kontostatus.aktiv{color:#28a745}
    /* NEU: Wichtig für die Durchstreichung */
    .konto-name.gesperrt{text-decoration:line-through;}

    /* List Item Clickable */
    .account-item{cursor:pointer; padding:10px; border-radius:8px;}
    .account-item:hover{background:#f9f9f9}
    
    /* Historie Tabs */
    .history-tabs{display:flex;margin-bottom:10px;gap:5px;}
    .history-tabs button{padding:6px 10px; font-size:14px; background:#f0f0f0; color:#333; border:1px solid #ccc; border-radius:8px;}
    .history-tabs button.active{background:var(--primary-color); color:#fff; border-color:var(--primary-color);}
    .history-detail-list h4{margin:5px 0 8px; font-size:16px; font-weight:600;}
    /* Formatierung für Historie (kleiner und kompakter) */
    .history-detail-list .entry{font-size:12px; margin-bottom: 5px; padding-left: 10px; border-left: 2px solid #ccc; white-space: pre-wrap;}
  </style>

  <script type="module">
    /* Firebase Imports */
    import { initializeApp as initApp1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB1, ref as ref1, set, onValue, remove, get, push, update } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB2, ref as ref2, get as get2, update as update2, onValue as onVal2, remove as remove2, set as set2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    import { initializeApp as initApp3 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB3, ref as ref3, onValue as onVal3, update as update3, remove as remove3, get as get3 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    /* Apps */
    const app1 = initApp1({
      apiKey:"AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
      authDomain:"gesamt-dae4e.firebaseapp.com",
      databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"gesamt-dae4e",
      storageBucket:"gesamt-dae4e.appspot.com",
      messagingSenderId:"844023612743",
      appId:"1:844023612743:web:0821aa894541f89a7df862"
    },"app1");
    const db1 = getDB1(app1);

    const app2 = initApp2({
      apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      authDomain:"punkte-45c20.firebaseapp.com",
      databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"punkte-45c20",
      storageBucket:"punkte-45c20.appspot.com",
      messagingSenderId:"931713539549",
      appId:"1:931713539549:web:e348bf38369639f1906a34"
    },"app2");
    const db2 = getDB2(app2);

    const app3 = initApp3({
      apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
    },"app3");
    const db3 = getDB3(app3);

    /* ===== Systemmodus (grün/gelb/rot) ===== */
    const modeRef = ref1(db1, "systemmode/state");
    const modeBtn = () => document.getElementById("mode-cycle");
    const modeDot = () => document.getElementById("mode-dot");
    const modeText = () => document.getElementById("mode-text");

    const order = ["green","yellow","red"];
    function nextMode(cur){
      const i = order.indexOf(cur); return order[(i<0?0:(i+1)%order.length)];
    }
    function labelFor(m){
      if(m==="green") return "Grün · Normal";
      if(m==="yellow") return "Gelb · Eingeschränkt";
      return "Rot · Gesperrt";
    }
    function dotClass(m){
      if(m==="green") return "dot-green";
      if(m==="yellow") return "dot-yellow";
      return "dot-red";
    }
    async function setMode(m){
      await set(modeRef, { value:m, updatedAt: Date.now() });
    }
    function renderMode(m){
      modeText().textContent = labelFor(m);
      modeDot().className = "mode-dot " + dotClass(m);
      modeBtn().title = "Modus wechseln";
    }

    onValue(modeRef, snap=>{
      const v = snap.exists() ? (snap.val().value||"green") : "green";
      renderMode(v);
    });

    window.addEventListener("DOMContentLoaded", ()=>{
      modeBtn().addEventListener("click", async ()=>{
        const snap = await get(modeRef);
        const cur = snap.exists() ? (snap.val().value||"green") : "green";
        await setMode(nextMode(cur));
      });
    });

    /* ===== Anpassungen Kontenverwaltung ===== */

    /* Farben und Mappings */
    const farben = ["⚪","🔴","🟡","🟢","⚫","🟣"];
    function farbeToColor(f){ if(f==="🔴")return"red"; if(f==="🟡")return"orange"; if(f==="🟢")return"green"; if(f==="⚫")return"black"; if(f==="🟣")return"purple"; return"#333";}
    function colorToDelta(f){ if(f==="🟢")return 5; if(f==="🟣")return 10; if(f==="🔴")return -5; if(f==="⚫")return -10; return 0;}
    const clamp01 = x => Math.max(0, Math.min(100, x|0));

    let GOALS_CACHE=null;
    async function ladeZieleMeta(){ if(GOALS_CACHE) return GOALS_CACHE; const snap=await get2(ref2(db2,"ziele/meta")); GOALS_CACHE=(snap.exists()&&Array.isArray(snap.val()))?snap.val():[]; return GOALS_CACHE;}
    window.zeigeAktivesZiel = async function(name){
      try{
        const [kidSnap,goals]=await Promise.all([get2(ref2(db2,`kinder/${name}`)), ladeZieleMeta()]);
        if(!kidSnap.exists()){ alert("Kein Datensatz gefunden."); return; }
        const v=kidSnap.val()||{};
        if(v.farbe===undefined){ alert("Dieses Konto hat keine Farbe und kein Ziel."); return; }
        const idx=Math.max(0,Math.min((goals.length||1)-1,(v.activeGoalIndex??0)|0));
        const titel=goals[idx]||"—";
        alert(`Aktives Ziel für ${name}\n\nZiel ${idx+1}: ${titel}\nFortschritt: ${v.progress||0}%`);
      }catch(e){ console.error(e); alert("Fehler beim Laden des Ziels."); }
    };

    async function updateProgress(name, delta) {
        const kidRef = ref2(db2, `kinder/${name}`);
        const snap = await get2(kidRef);
        if (!snap.exists()) return;
        const kid = snap.val() || {};
        if (kid.progress === undefined) {
            alert("Dieses Konto unterstützt keinen Ziel-Fortschritt.");
            return;
        }
        const currentProgress = kid.progress || 0;
        const newProgress = clamp01(currentProgress + delta);
        await update2(kidRef, { progress: newProgress });
    }
    window.increaseProgress = (name) => updateProgress(name, 5);
    window.decreaseProgress = (name) => updateProgress(name, -5);

    async function rewardMilestonesAndMaybeComplete(name,kid,newProgress){
      let saldo=kid.punkte||0; let last=kid.lastRewardedMilestone??0;
      const capped=Math.min(newProgress,100); const from=Math.floor(Math.max(last,0)/10); const to=Math.floor(capped/10);
      if(to>from){ for(let m=from+1;m<=to&&m<10;m++){ saldo+=1; last=m*10; } }
      if(capped>=100){
        if(last<100){ saldo+=1; last=100; }
        await update2(ref2(db2,`kinder/${name}`),{punkte:saldo,progress:100,lastRewardedMilestone:100,needsGoalAssignment:true,farbe:"⚪"});
        renderAbschluesse();
      } else {
        await update2(ref2(db2,`kinder/${name}`),{punkte:saldo,lastRewardedMilestone:last,progress:clamp01(capped),farbe:"⚪"});
      }
    }

    async function durchfuehren(){
      const snapshot=await get2(ref2(db2,"kinder")); const ops=[];
      snapshot.forEach(childSnap=>{
        const name=childSnap.key; const kid=childSnap.val()||{};
        if(kid.farbe===undefined) return;
        const newP=clamp01((kid.progress??0)+colorToDelta(kid.farbe));
        ops.push(rewardMilestonesAndMaybeComplete(name,{punkte:kid.punkte||0,farbe:kid.farbe,activeGoalIndex:kid.activeGoalIndex??0,progress:kid.progress??0,lastRewardedMilestone:kid.lastRewardedMilestone??0},newP));
      });
      await Promise.all(ops);
      renderAbschluesse();
    }

    async function renderAbschluesse(){
      const section=document.getElementById("abschluss-section");
      const box=document.getElementById("abschluss-wartend");
      box.innerHTML=""; let count=0;
      const [kSnap,goals]=await Promise.all([get2(ref2(db2,"kinder")), ladeZieleMeta()]);
      if(kSnap.exists()){
        kSnap.forEach(ch=>{
          const name=ch.key; const v=ch.val()||{};
          if(v.farbe===undefined) return;
          if(v.progress===100 && v.needsGoalAssignment){
            const zielTitel=goals[(v.activeGoalIndex??0)]||"—";
            const row=document.createElement("div"); row.className="flex";
            row.innerHTML=`<div><b>${name}</b> hat 100 % erreicht – „${zielTitel}“.</div>
              <div class="flex-buttons">
                <button class="small-button" onclick="vergebeFinale5('${name}')">Bonus +5</button>
                <button class="small-button" onclick="naechstesZiel('${name}')">Nächstes Ziel</button>
              </div>`;
            box.appendChild(row); count++;
          }
        });
      }
      section.style.display = count>0 ? "block":"none";
    }
    window.vergebeFinale5 = async function(name){
      const s=await get2(ref2(db2,`kinder/${name}`)); if(!s.exists())return;
      const v=s.val()||{}; await update2(ref2(db2,`kinder/${name}`),{punkte:(v.punkte||0)+5});
      alert(`${name}: +5 Mausdollar vergeben.`); renderAbschluesse();
    };
    window.naechstesZiel = async function(name){
      const s=await get2(ref2(db2,`kinder/${name}`)); if(!s.exists())return;
      const v=s.val()||{}; const goals=await ladeZieleMeta();
      const nextIdx=Math.min((goals.length?goals.length:1)-1,(v.activeGoalIndex??0)+1);
      await update2(ref2(db2,`kinder/${name}`),{activeGoalIndex:nextIdx,progress:0,lastRewardedMilestone:0,needsGoalAssignment:false});
      alert(`${name}: auf nächstes Ziel gesetzt.`); renderAbschluesse();
    };

    function ladeKinderKonten(){
      const bereich=document.getElementById("mauscity-konten-liste");
      const eigeneKinder=new Map();
      onValue(ref1(db1,"kinder"),(snapshot)=>{
        eigeneKinder.clear(); snapshot.forEach(childSnap=>{ eigeneKinder.set(childSnap.key, childSnap.val() || {}); });
        onVal2(ref2(db2,"kinder"),(snapshot2)=>{
          bereich.innerHTML="";
          snapshot2.forEach(childSnap2=>{
            const name=childSnap2.key; const data2=childSnap2.val();
            const data1 = eigeneKinder.get(name);

            if(!data1) return;

            const isLocked = data1.gesperrt === true;
            
            const zeile=document.createElement("div"); zeile.className="flex account-item";
            zeile.onclick = () => openAccountManager(name, { ...data1, ...data2 }); 

            const kontoInfo=document.createElement("div");
            // Durchstreichung angewendet basierend auf data1.gesperrt
            kontoInfo.innerHTML=`<span class="konto-name ${isLocked ? 'gesperrt' : ''}" style="color:${farbeToColor(data2.farbe)};font-weight:bold;">${name}</span>
              <button class="small-button" title="Aktives Ziel zeigen" onclick="event.stopPropagation(); zeigeAktivesZiel('${name}')">Z</button>`;
              
            const progressButtons=document.createElement("div"); progressButtons.className="flex-buttons";

            if(data2.progress!==undefined){
              const plus5=document.createElement("button"); plus5.textContent="+5 %"; 
              plus5.onclick=(e)=>{ e.stopPropagation(); updateProgress(name, 5); }; // Direkter Aufruf der Funktion
              const minus5=document.createElement("button"); minus5.textContent="–5 %"; 
              minus5.onclick=(e)=>{ e.stopPropagation(); updateProgress(name, -5); }; // Direkter Aufruf der Funktion
              progressButtons.appendChild(plus5); progressButtons.appendChild(minus5);
            } else {
              progressButtons.innerHTML="—";
            }
            
            zeile.appendChild(kontoInfo); 
            zeile.appendChild(progressButtons); 
            
            if(data2.farbe!==undefined){
              const farbButtons=document.createElement("div"); farbButtons.className="flex-buttons";
              ["⚪","🔴","🟡","🟢","⚫","🟣"].forEach(f=>{
                const btn=document.createElement("button"); btn.textContent=f; btn.className="color-button"; btn.title="Farbe setzen";
                btn.onclick=(e)=>{ e.stopPropagation(); update2(ref2(db2,`kinder/${name}`),{farbe:f}); }; farbButtons.appendChild(btn);
              });
              zeile.appendChild(farbButtons);
            }
            bereich.appendChild(zeile);
          });
        });
      });
    }
    async function alleAufGruen(){ const snapshot=await get2(ref2(db2,"kinder")); snapshot.forEach(childSnap=>{ const name=childSnap.key; const data=childSnap.val(); if(data.farbe!==undefined){ update2(ref2(db2,`kinder/${name}`),{farbe:"🟢"}); } }); }
    async function alleAufWeiss(){ const snapshot=await get2(ref2(db2,"kinder")); snapshot.forEach(childSnap=>{ const name=childSnap.key; const data=childSnap.val(); if(data.farbe!==undefined){ update2(ref2(db2,`kinder/${name}`),{farbe:"⚪"}); } }); }

    // Modal Funktionen

    const modal = document.getElementById('account-manager-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalStatus = document.getElementById('modal-status');
    const linkInput = document.getElementById('modal-link-input');
    const codeInput = document.getElementById('modal-code-input');
    const sperrGrundInput = document.getElementById('modal-sperr-grund');
    const sperrButton = document.getElementById('modal-sperr-btn');
    const deleteButton = document.getElementById('modal-delete-btn');
    let currentAccountName = null;

    function closeModal() { modal.style.display = 'none'; }
    window.closeModal = closeModal;

    window.openAccountManager = (name, data) => {
      currentAccountName = name;
      modalTitle.textContent = `Konto: ${name}`;
      
      const isLocked = data.gesperrt === true;
      modalStatus.textContent = isLocked ? `Status: GESPERRT (Grund: ${data.sperrGrund || 'Nicht angegeben'})` : 'Status: Aktiv';
      modalStatus.className = 'kontostatus ' + (isLocked ? 'gesperrt' : 'aktiv');

      linkInput.value = data.link || '';
      codeInput.value = data.code || '';
      sperrGrundInput.value = data.sperrGrund || '';

      sperrGrundInput.parentElement.style.display = 'block';
      sperrGrundInput.placeholder = isLocked ? 'Aktueller Sperr-Grund' : 'Grund für die Sperrung angeben';

      sperrButton.textContent = isLocked ? 'Entsperren' : 'Sperren';
      sperrButton.className = 'action-button ' + (isLocked ? 'green' : 'red');

      modal.style.display = 'flex';
    };

    window.saveLinkCode = async (name) => {
        const link = linkInput.value.trim();
        const code = codeInput.value.trim();
        if (!name) return;
        await update(ref1(db1, `kinder/${name}`), { link: link || null, code });
        alert(`Link/Code für ${name} gespeichert.`);
        closeModal();
    };

    // FUNKTION MIT KORRIGIERTEM VERHALTEN (Bugfix)
    window.toggleLock = async (name) => {
        const snap = await get(ref1(db1, `kinder/${name}`));
        const data = snap.val() || {};
        const isCurrentlyLocked = data.gesperrt === true;

        if (isCurrentlyLocked) {
            // Entsperren: Setze gesperrt und sperrGrund auf null
            await update(ref1(db1, `kinder/${name}`), { gesperrt: null, sperrGrund: null });
            alert(`${name} wurde entsperrt.`);
        } else {
            // Sperren
            const grund = sperrGrundInput.value.trim();
            if (!grund) {
                alert("Bitte einen Grund für die Sperrung angeben.");
                sperrGrundInput.focus();
                return;
            }
            // Sperren: Setze gesperrt auf true und speichere den Grund
            await update(ref1(db1, `kinder/${name}`), { gesperrt: true, sperrGrund: grund });
            alert(`${name} wurde gesperrt. Grund: ${grund}`);
        }
        // Wichtig: Schließe das Modal und die Kontenliste wird durch den onValue-Listener neu gerendert
        closeModal();
    };

    window.permanentDelete = (name) => {
        if (confirm(`Bist du WIRKLICH SICHER, das gesamte Konto von ${name} dauerhaft zu löschen? Alle Punkte, Ziele und Zugänge werden gelöscht.`)) {
            remove2(ref2(db2,"kinder/"+name)).catch(err=>console.error("Fehler MausCity:",err));
            remove(ref1(db1,"kinder/"+name)).catch(err=>console.error("Fehler AdminDB:",err));
            alert(`Konto von ${name} wurde dauerhaft gelöscht.`);
            closeModal();
        }
    };
    
    function ladeAktuelleAusleihen(){
      const ausleihenListe=document.getElementById("ausleihen-liste");
      onValue(ref1(db1,"ausleihen"),(snapshot)=>{
        ausleihenListe.innerHTML="";
        snapshot.forEach(childSnap=>{
          const name=childSnap.key; const daten=childSnap.val();
          const div=document.createElement("div"); div.className="flex";
          div.innerHTML=`<b>${name}</b> hat <i>${daten.spielzeug}</i> ausgeliehen`;
          const button=document.createElement("button"); button.textContent="Zurückgeben"; button.onclick=()=>zurueckgeben(name);
          div.appendChild(button); ausleihenListe.appendChild(div);
        });
      });
    }
    window.zurueckgeben = async function(name){
      const ausleiheRef=ref1(db1,"ausleihen/"+name); const snapshot=await get(ausleiheRef); if(!snapshot.exists())return;
      const daten=snapshot.val(); const historieRef=ref1(db1,"historie/"+name);
      const neueHistorie={spielzeug:daten.spielzeug,nummer:daten.nummer,ausgeliehen:daten.zeit,zurückgegeben:new Date().toISOString()};
      const neueRef=push(historieRef); await set(neueRef,neueHistorie); await remove(ausleiheRef);
      ladeHistorie();
    };

    function ladeKinderHinzufuegen(){
      const addKindBtn=document.getElementById("add-kind-btn");
      addKindBtn.onclick=()=>{
        const name=document.getElementById("kind-name").value.trim();
        let link=document.getElementById("checkout-link").value.trim();
        const code=document.getElementById("security-code").value.trim();
        const istGruppenkonto=document.getElementById("ist-gruppen")?.checked;
        const istGastkonto=document.getElementById("ist-gast")?.checked;
        if(!name||!code) return alert("Name und Sicherheitscode sind erforderlich.");
        if(link && !link.startsWith("http")) link="https://"+link;
        // Beim Hinzufügen: gesperrt und sperrGrund initialisieren
        set(ref1(db1,`kinder/${name}`),{link:link || null, code, gesperrt: null, sperrGrund: null});
        if(istGruppenkonto){ set2(ref2(db2,`kinder/${name}`),{punkte:0,farbe:"⚪", progress: 0}); }
        else if(istGastkonto){ set2(ref2(db2,`kinder/${name}`),{punkte:0}); }
        document.getElementById("kind-name").value=""; document.getElementById("checkout-link").value=""; document.getElementById("security-code").value="";
        if(document.getElementById("ist-gruppen")) document.getElementById("ist-gruppen").checked=false;
        if(document.getElementById("ist-gast")) document.getElementById("ist-gast").checked=false; 
      };
    }
    
    function ladeSpielzeugeHinzufuegen(){
      const addSpielzeugBtn=document.getElementById("add-spielzeug-btn");
      addSpielzeugBtn.onclick=()=>{
        const nummer=document.getElementById("spielzeug-nummer").value.trim();
        const name=document.getElementById("spielzeug-name").value.trim();
        if(!nummer||!name) return alert("Nummer oder Name fehlt.");
        set(ref1(db1,`spielzeuge/${nummer}`),name);
        document.getElementById("spielzeug-nummer").value=""; document.getElementById("spielzeug-name").value="";
      };
      const spielzeugListe=document.getElementById("spielzeug-liste");
      onValue(ref1(db1,"spielzeuge"),(snapshot)=>{
        spielzeugListe.innerHTML="";
        snapshot.forEach(childSnap=>{
          const nummer=childSnap.key; const name=childSnap.val();
          const div=document.createElement("div");
          div.innerHTML=`${nummer}: ${name} <span class="delete" onclick="loescheSpielzeug('${nummer}')">x</span>`;
          spielzeugListe.appendChild(div);
        });
      });
    }
    window.loescheSpielzeug = function(nummer){ if(confirm(`Soll Spielzeug ${nummer} wirklich gelöscht werden?`)){ remove(ref1(db1,"spielzeuge/"+nummer)); } };

    let GESAMTE_HISTORIE_CACHE = null;
    let SPIELZEUGE_CACHE = {};
    let HISTORY_MODE = 'kind'; // 'kind' oder 'spielzeug'

    // Formatiert Zeit wie gewünscht (z.B. 1.8.25 12:30)
    function formatTime(isoString) {
        if (!isoString) return 'Unbekannt';
        const d = new Date(isoString);
        const tag = d.getDate();
        const monat = d.getMonth() + 1;
        const jahr = d.getFullYear() % 100;
        const stunde = d.getHours();
        const minute = String(d.getMinutes()).padStart(2, '0');
        
        return `${tag}.${monat}.${jahr} ${stunde}:${minute}`;
    }

    async function ladeHistorieDaten() {
        // Lade alle benötigten Daten (Historie und Spielzeugnamen)
        const [historieSnap, spielzeugSnap] = await Promise.all([
            get(ref1(db1, "historie")),
            get(ref1(db1, "spielzeuge"))
        ]);

        SPIELZEUGE_CACHE = spielzeugSnap.exists() ? spielzeugSnap.val() : {};

        const alleEintraege = {};
        if (historieSnap.exists()) {
            historieSnap.forEach(kindSnap => {
                const kind = kindSnap.key;
                const eintraege = kindSnap.val();
                for (const key in eintraege) {
                    const eintrag = eintraege[key];
                    if (!alleEintraege[kind]) alleEintraege[kind] = [];
                    // Umwandlung in Millisekunden für die Sortierung
                    alleEintraege[kind].push({ ...eintrag, kind, key, sortTime: new Date(eintrag.zurückgegeben).getTime() });
                }
            });
        }
        GESAMTE_HISTORIE_CACHE = alleEintraege;
        return alleEintraege;
    }

    function renderHistorieListe(mode) {
        const liste = document.getElementById("historie-detail-list");
        liste.innerHTML = "";
        
        if (!GESAMTE_HISTORIE_CACHE) return;
        
        let elements = [];

        if (mode === 'kind') {
            const kinder = Object.keys(GESAMTE_HISTORIE_CACHE).sort();
            kinder.forEach(kind => {
                const eintraege = GESAMTE_HISTORIE_CACHE[kind].sort((a, b) => b.sortTime - a.sortTime);
                const box = document.createElement("div");
                box.innerHTML = `<h4>${kind}</h4>`;
                eintraege.forEach(eintrag => {
                    const spielzeugName = SPIELZEUGE_CACHE[eintrag.nummer] || `Nr. ${eintrag.nummer} (Unbekannt)`;
                    const von = formatTime(eintrag.ausgeliehen);
                    const bis = formatTime(eintrag.zurückgegeben);
                    box.innerHTML += `<div class="entry">• **${spielzeugName}**: von ${von} bis ${bis} <span class="delete" onclick="loescheHistorie('${eintrag.kind}','${eintrag.key}')">x</span></div>`;
                });
                elements.push(box);
            });
        } else if (mode === 'spielzeug') {
            const spielzeugeMap = {};
            // Einträge nach Spielzeug gruppieren
            Object.values(GESAMTE_HISTORIE_CACHE).flat().forEach(eintrag => {
                const nummer = eintrag.nummer;
                if (!spielzeugeMap[nummer]) spielzeugeMap[nummer] = [];
                spielzeugeMap[nummer].push(eintrag);
            });
            
            const nummern = Object.keys(spielzeugeMap).sort((a, b) => Number(a) - Number(b));
            
            nummern.forEach(nummer => {
                const eintraege = spielzeugeMap[nummer].sort((a, b) => b.sortTime - a.sortTime);
                const spielzeugName = SPIELZEUGE_CACHE[nummer] || `Nr. ${nummer} (Unbekannt)`;
                
                const box = document.createElement("div");
                box.innerHTML = `<h4>${spielzeugName} (Nr. ${nummer})</h4>`;
                eintraege.forEach(eintrag => {
                    const von = formatTime(eintrag.ausgeliehen);
                    const bis = formatTime(eintrag.zurückgegeben);
                    box.innerHTML += `<div class="entry">• **${eintrag.kind}**: von ${von} bis ${bis} <span class="delete" onclick="loescheHistorie('${eintrag.kind}','${eintrag.key}')">x</span></div>`;
                });
                elements.push(box);
            });
        }
        
        elements.forEach(el => liste.appendChild(el));
    }
    
    window.switchHistoryMode = (mode) => {
        HISTORY_MODE = mode;
        document.getElementById('tab-kind').classList.toggle('active', mode === 'kind');
        document.getElementById('tab-spielzeug').classList.toggle('active', mode === 'spielzeug');
        renderHistorieListe(mode);
    };

    function ladeHistorie() {
      // Setzt den Cache zurück und lädt die Daten neu bei Änderungen in Firebase
      onValue(ref1(db1, "historie"), async () => {
          GESAMTE_HISTORIE_CACHE = null; // Cache ungültig machen
          await ladeHistorieDaten();
          // Nach dem Laden die aktuelle Ansicht neu rendern
          switchHistoryMode(HISTORY_MODE);
      });
    }

    window.loescheHistorie=function(name,key){ 
        if(confirm(`Eintrag von ${name} wirklich löschen?`)){ 
            remove(ref1(db1,`historie/${name}/${key}`)); 
        } 
    };
    

    window.addEventListener("DOMContentLoaded",()=>{
      ladeAktuelleAusleihen();
      // Wichtig: ladeKinderKonten muss zuerst kommen
      ladeKinderKonten();
      document.getElementById('durchfuehren-btn')?.addEventListener('click', async ()=>{ await durchfuehren(); });
      document.getElementById('alle-gruen-btn')?.addEventListener('click', alleAufGruen);
      document.getElementById('alle-weiss-btn')?.addEventListener('click', alleAufWeiss);
      renderAbschluesse();
      ladeKinderHinzufuegen(); 
      ladeSpielzeugeHinzufuegen(); 
      ladeHistorie(); 
      switchHistoryMode('kind');
      ladeKurznachrichten();
    });
  </script>
</head>
<body>
  <div id="account-manager-modal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
      <h3 id="modal-title">Konto: [Name]</h3>
      <div id="modal-status" class="kontostatus">Status: Aktiv</div>

      <div class="form-group">
        <label for="modal-link-input">Checkout-Link</label>
        <input id="modal-link-input" type="text" placeholder="Checkout-Link" />
      </div>
      <div class="form-group">
        <label for="modal-code-input">Sicherheitscode (PIN)</label>
        <input id="modal-code-input" type="text" placeholder="3-stelliger Code" maxlength="3" />
      </div>

      <button onclick="saveLinkCode(currentAccountName)" class="action-button full">Link & Code speichern</button>
      
      <hr style="margin: 15px 0; border: none; border-top: 1px solid #eee;">

      <div class="form-group">
        <label for="modal-sperr-grund" id="sperr-grund-label">Sperr-Grund</label>
        <textarea id="modal-sperr-grund" placeholder="Grund für die Sperrung"></textarea>
      </div>
      <button id="modal-sperr-btn" onclick="toggleLock(currentAccountName)" class="action-button"></button>

      <div class="modal-actions">
        <button class="secondary" onclick="closeModal()">Abbrechen</button>
        <button id="modal-delete-btn" class="red" onclick="permanentDelete(currentAccountName)">Dauerhaft löschen</button>
      </div>
    </div>
  </div>

<div class="page-wrap">
  <div class="topbar">
    <div class="mode-wrap">
      <button id="mode-cycle" class="mode-cycle" title="Modus wechseln">
        <span id="mode-dot" class="mode-dot dot-green"></span>
        <span id="mode-text" class="mode-text">Grün · Normal</span>
      </button>
    </div>
    <div class="title">Adminbereich</div>
  </div>

  <div class="section">
    <h2>Aktuelle Ausleihen</h2>
    <div class="liste" id="ausleihen-liste"></div>
  </div>

  <div class="section" id="abschluss-section" style="display:none">
    <h2>Abschlüsse warten auf Freigabe</h2>
    <div class="liste callout" id="abschluss-wartend"></div>
  </div>

  <div class="section">
    <div class="shop-admin-header"> 
      <h2>Konten</h2>
      <div class="action-buttons">
        <button id="durchfuehren-btn" class="action-button execute" title="Farben → Ziel-Fortschritt anwenden">✔️</button>
        <button id="alle-gruen-btn" class="action-button green" title="Alle auf Grün setzen">Alle</button>
        <button id="alle-weiss-btn" class="action-button white" title="Alle auf Weiß setzen">Alle</button>
      </div>
    </div>
    <div class="liste" id="mauscity-konten-liste"></div>
  </div>

  <div class="section">
    <h2>Kurznachrichten</h2>
    <div class="row">
      <input id="notice-title" type="text" placeholder="Titel (optional, z. B. Nachricht)" />
      <input id="notice-text" type="text" placeholder="Nachrichtentext" />
    </div>
    <div class="row">
      <select id="notice-color" aria-label="Farbe">
        <option value="blue">Blau</option><option value="red">Rot</option><option value="green">Grün</option>
        <option value="orange">Orange</option><option value="purple">Lila</option><option value="black">Schwarz</option><option value="gray">Grau</option>
      </select>
      <input id="notice-start" type="datetime-local" aria-label="Start" />
      <input id="notice-end" type="datetime-local" aria-label="Ende" />
    </div>
    <button id="add-notice-btn">Neue Kurznachricht hinzufügen</button>
    <div class="liste" id="kurznachrichten-liste"></div>
  </div>

  <div class="section">
    <h2>Kinder hinzufügen</h2>
    <div class="form-group">
      <input id="kind-name" type="text" placeholder="Name des Kindes" />
      <input id="checkout-link" type="text" placeholder="Checkout-Link (optional)" />
      <input id="security-code" type="text" placeholder="3-stelliger Code" />
    </div>
    <div class="checkboxes">
      <label><input type="checkbox" id="ist-gruppen"> Gruppenkonto hinzufügen</label>
      <label><input type="checkbox" id="ist-gast"> Gastkonto hinzufügen</label>
    </div>
    <button id="add-kind-btn">Hinzufügen</button>
  </div>

  <div class="section">
    <h2>Spielzeuge hinzufügen</h2>
    <div class="form-group inline">
      <input id="spielzeug-nummer" type="text" placeholder="Nummer" style="width: 100px;"/>
      <input id="spielzeug-name" type="text" placeholder="Spielzeugname" style="flex-grow: 1;"/>
      <button id="add-spielzeug-btn">Hinzufügen</button>
    </div>
    <div class="liste" id="spielzeug-liste"></div>
  </div>

  <div class="section">
    <h2>Ausleih-Historie</h2>
    <div class="history-tabs">
        <button id="tab-kind" class="active" onclick="switchHistoryMode('kind')">Nach Kind auswählen</button>
        <button id="tab-spielzeug" onclick="switchHistoryMode('spielzeug')">Nach Spielzeug auswählen</button>
    </div>
    <div class="history-detail-list" id="historie-detail-list"></div>
  </div>
</div>
</body>
</html>

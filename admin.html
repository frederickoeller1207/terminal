<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì M√§usegruppe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007aff;
      --primary-hover-color: #005bb5;
      --background-color: #f4f4f4;
      --card-background-color: #fff;
      --text-color: #333;
      --border-radius: 12px;
      --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      --font-size-small: 14px;
      --font-size-medium: 16px;
      --font-size-large: 24px;
    }

    body {
      font-family: 'SF Pro Display', sans-serif;
      padding: 15px;
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: var(--font-size-medium);
      line-height: 1.6;
    }
    
    h1 {
      font-size: 22px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      color: var(--primary-color);
    }

    h2 {
      font-size: 18px;
      margin: 0 0 15px 0;
      font-weight: 600;
    }
    
    input[type="text"], input[type="number"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: var(--font-size-small);
      width: 100%;
      box-sizing: border-box;
    }

    button {
      padding: 8px 14px;
      font-size: var(--font-size-small);
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      font-weight: 600;
      white-space: nowrap;
    }

    button:hover {
      background-color: var(--primary-hover-color);
    }
    
    .section {
      background: var(--card-background-color);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    .form-group.inline {
      flex-direction: row;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
    }
    
    .checkboxes {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .liste {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .liste > div {
      padding: 10px 0;
      border-bottom: 1px solid #f9f9f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .liste > div:last-child {
      border-bottom: none;
    }

    .liste h3 {
      font-size: var(--font-size-medium);
      margin-top: 20px;
    }

    .delete {
      color: #ff3b30;
      cursor: pointer;
      margin-left: 10px;
      font-weight: 600;
      font-size: var(--font-size-small);
    }
    
    .delete:hover {
      text-decoration: underline;
    }

    .flex {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    
    .flex-buttons {
      display: flex;
      gap: 5px;
    }

    .color-button {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 2px 5px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .color-button:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .request-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
      gap: 10px;
    }

    .request-item:last-child {
      border-bottom: none;
    }

    .request-info {
      flex-grow: 1;
    }
  </style>
  <script type="module">
    import { initializeApp as initApp1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB1, ref as ref1, set, onValue, remove, get, push } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB2, ref as ref2, get as get2, update as update2, onValue as onVal2, remove as remove2, set as set2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const app1 = initApp1({
      apiKey: "AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
      authDomain: "gesamt-dae4e.firebaseapp.com",
      databaseURL: "https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gesamt-dae4e",
      storageBucket: "gesamt-dae4e.appspot.com",
      messagingSenderId: "844023612743",
      appId: "1:844023612743:web:0821aa894541f89a7df862"
    }, "app1");
    const db1 = getDB1(app1);

    const app2 = initApp2({
      apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      authDomain: "punkte-45c20.firebaseapp.com",
      databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "punkte-45c20",
      storageBucket: "punkte-45c20.appspot.com",
      messagingSenderId: "931713539549",
      appId: "1:931713539549:web:e348bf38369639f1906a34"
    }, "app2");
    const db2 = getDB2(app2);

    const farben = ["‚ö™", "üî¥", "üü°", "üü¢", "‚ö´", "üü£"];
    function farbeToColor(f) {
      if (f === "üî¥") return "red";
      if (f === "üü°") return "orange";
      if (f === "üü¢") return "green";
      if (f === "‚ö´") return "black";
      if (f === "üü£") return "purple";
      return "gray";
    }

    window.addEventListener("DOMContentLoaded", () => {
      ladeMausdollarAnfragen();
      ladeAktuelleAusleihen();
      ladeKinderKonten();
      ladeKinderHinzufuegen();
      ladeSpielzeugeHinzufuegen();
      ladeHistorie();
      ladeKontoLoeschen();
    });

    function ladeMausdollarAnfragen() {
      const container = document.getElementById("mausdollar-anfragen-liste");
      onValue(ref1(db1, "anfragen"), (snapshot) => {
        container.innerHTML = "";
        snapshot.forEach(childSnap => {
          const id = childSnap.key;
          const data = childSnap.val();
          const zeile = document.createElement("div");
          zeile.className = "request-item";
          zeile.innerHTML = `
            <div class="request-info">${data.name} m√∂chte ${data.betrag} Punkt(e) wegen **${data.grund}**</div>
            <div class="flex-buttons">
              <button onclick="bestaetigeAnfrage('${id}', '${data.name}', ${data.betrag})">‚úîÔ∏è</button>
              <button onclick="lehneAnfrage('${id}')">‚ùå</button>
            </div>
          `;
          container.appendChild(zeile);
        });
      });
    }

    window.bestaetigeAnfrage = async function(id, name, betrag) {
      const kindRef = ref2(db2, `kinder/${name}`);
      const kindSnap = await get2(kindRef);
      const val = kindSnap.val() || { punkte: 0, farbe: "‚ö™" };
      await update2(kindRef, { punkte: val.punkte + betrag });
      remove(ref1(db1, "anfragen/" + id));
    };
    
    window.lehneAnfrage = function(id) {
      remove(ref1(db1, "anfragen/" + id));
    };

    function ladeAktuelleAusleihen() {
      const ausleihenListe = document.getElementById("ausleihen-liste");
      onValue(ref1(db1, "ausleihen"), (snapshot) => {
        ausleihenListe.innerHTML = "";
        snapshot.forEach(childSnap => {
          const name = childSnap.key;
          const daten = childSnap.val();
          const div = document.createElement("div");
          div.className = "flex";
          div.innerHTML = `<b>${name}</b> hat <i>${daten.spielzeug}</i> ausgeliehen`;
          const button = document.createElement("button");
          button.textContent = "Zur√ºckgeben";
          button.onclick = () => zurueckgeben(name);
          div.appendChild(button);
          ausleihenListe.appendChild(div);
        });
      });
    }

    window.zurueckgeben = async function(name) {
      const ausleiheRef = ref1(db1, "ausleihen/" + name);
      const snapshot = await get(ausleiheRef);
      if (!snapshot.exists()) return;
      const daten = snapshot.val();
      const historieRef = ref1(db1, "historie/" + name);
      const neueHistorie = {
        spielzeug: daten.spielzeug,
        nummer: daten.nummer,
        ausgeliehen: daten.zeit,
        zur√ºckgegeben: new Date().toISOString()
      };
      const neueRef = push(historieRef);
      await set(neueRef, neueHistorie);
      await remove(ausleiheRef);
    };

    function ladeKinderKonten() {
      const bereich = document.getElementById("mauscity-konten-liste");
      const eigeneKinder = new Set();
      onValue(ref1(db1, "kinder"), (snapshot) => {
        eigeneKinder.clear();
        snapshot.forEach(childSnap => {
          eigeneKinder.add(childSnap.key);
        });
        onVal2(ref2(db2, "kinder"), (snapshot2) => {
          bereich.innerHTML = "";
          snapshot2.forEach(childSnap2 => {
            const name = childSnap2.key;
            const data = childSnap2.val();
            if (!eigeneKinder.has(name)) return;
            const zeile = document.createElement("div");
            zeile.className = "flex";
            
            const kontoInfo = document.createElement("div");
            kontoInfo.innerHTML = `<span>${name}</span> (<span style="color: ${farbeToColor(data.farbe)}; font-weight: bold;">${data.punkte}</span>)`;
            
            const punkteButtons = document.createElement("div");
            punkteButtons.className = "flex-buttons";
            const plus = document.createElement("button");
            plus.textContent = "+";
            plus.onclick = () => update2(ref2(db2, `kinder/${name}`), { punkte: data.punkte + 1 });
            const minus = document.createElement("button");
            minus.textContent = "‚Äì";
            minus.onclick = () => update2(ref2(db2, `kinder/${name}`), { punkte: data.punkte - 1 });
            punkteButtons.appendChild(plus);
            punkteButtons.appendChild(minus);

            zeile.appendChild(kontoInfo);
            zeile.appendChild(punkteButtons);

            // NEUE FUNKTIONALIT√ÑT: Farbauswahl nur f√ºr Kinder ohne '~'
            if (!name.includes("~")) {
              const farbButtons = document.createElement("div");
              farbButtons.className = "flex-buttons";
              farben.forEach(f => {
                const btn = document.createElement("button");
                btn.textContent = f;
                btn.className = "color-button";
                btn.onclick = () => update2(ref2(db2, `kinder/${name}`), { farbe: f });
                farbButtons.appendChild(btn);
              });
              zeile.appendChild(farbButtons);
            }
            
            bereich.appendChild(zeile);
          });
        });
      });
    }

    function ladeKinderHinzufuegen() {
      const addKindBtn = document.getElementById("add-kind-btn");
      addKindBtn.onclick = () => {
        const name = document.getElementById("kind-name").value.trim();
        let link = document.getElementById("checkout-link").value.trim();
        const code = document.getElementById("security-code").value.trim();
        const istGruppenkonto = document.getElementById("ist-gruppen")?.checked;
        const istAuslandskonto = document.getElementById("ist-ausland")?.checked;

        if (!name || !code) return alert("Name und Sicherheitscode sind erforderlich.");
        if (link && !link.startsWith("http")) link = "https://" + link;

        set(ref1(db1, `kinder/${name}`), { link: link || null, code });

        if (istGruppenkonto) {
          set2(ref2(db2, `kinder/${name}`), { punkte: 0, farbe: "‚ö™" });
        } else if (istAuslandskonto) {
          set2(ref2(db2, `kinder/${name}`), { punkte: 0 });
        }

        document.getElementById("kind-name").value = "";
        document.getElementById("checkout-link").value = "";
        document.getElementById("security-code").value = "";
        if (document.getElementById("ist-gruppen")) document.getElementById("ist-gruppen").checked = false;
        if (document.getElementById("ist-ausland")) document.getElementById("ist-ausland").checked = false;
      };

      const kinderListe = document.getElementById("kinder-liste");
      onValue(ref1(db1, "kinder"), (snapshot) => {
        kinderListe.innerHTML = "";
        snapshot.forEach(childSnap => {
          const name = childSnap.key;
          const data = childSnap.val();
          const div = document.createElement("div");
          div.innerHTML = `${name} ‚Äì Link: ${data.link || "kein Link"} ‚Äì Code: ${data.code || "kein Code"} <span class="delete" onclick="loescheKind('${name}')">x</span>`;
          kinderListe.appendChild(div);
        });
      });
    }

    window.loescheKind = function(name) {
      if (confirm(`Soll ${name} wirklich gel√∂scht werden?`)) {
        remove(ref1(db1, "kinder/" + name));
      }
    };

    function ladeSpielzeugeHinzufuegen() {
      const addSpielzeugBtn = document.getElementById("add-spielzeug-btn");
      addSpielzeugBtn.onclick = () => {
        const nummer = document.getElementById("spielzeug-nummer").value.trim();
        const name = document.getElementById("spielzeug-name").value.trim();
        if (!nummer || !name) return alert("Nummer oder Name fehlt.");
        set(ref1(db1, `spielzeuge/${nummer}`), name);
        document.getElementById("spielzeug-nummer").value = "";
        document.getElementById("spielzeug-name").value = "";
      };

      const spielzeugListe = document.getElementById("spielzeug-liste");
      onValue(ref1(db1, "spielzeuge"), (snapshot) => {
        spielzeugListe.innerHTML = "";
        snapshot.forEach(childSnap => {
          const nummer = childSnap.key;
          const name = childSnap.val();
          const div = document.createElement("div");
          div.innerHTML = `${nummer}: ${name} <span class="delete" onclick="loescheSpielzeug('${nummer}')">x</span>`;
          spielzeugListe.appendChild(div);
        });
      });
    }

    window.loescheSpielzeug = function(nummer) {
      if (confirm(`Soll Spielzeug ${nummer} wirklich gel√∂scht werden?`)) {
        remove(ref1(db1, "spielzeuge/" + nummer));
      }
    };
    
    function ladeHistorie() {
      const historieListe = document.getElementById("historie-liste");
      onValue(ref1(db1, "historie"), async (snapshot) => {
        historieListe.innerHTML = "";
        const alleEintraege = {};
        snapshot.forEach(childSnap => {
          const kind = childSnap.key;
          const eintraege = childSnap.val();
          for (const key in eintraege) {
            const eintrag = eintraege[key];
            const nummer = eintrag.nummer;
            if (!alleEintraege[nummer]) alleEintraege[nummer] = [];
            alleEintraege[nummer].push({ ...eintrag, kind, key });
          }
        });
        const sortierteNummern = Object.keys(alleEintraege).sort((a, b) => Number(a) - Number(b));
        for (const nummer of sortierteNummern) {
          const box = document.createElement("div");
          const nameRef = ref1(db1, "spielzeuge/" + nummer);
          const nameSnap = await get(nameRef);
          const name = nameSnap.exists() ? nameSnap.val() : "Unbekannt";
          box.innerHTML = `<h3>${nummer}: ${name}</h3>`;
          alleEintraege[nummer].sort((a, b) => new Date(b.zur√ºckgegeben) - new Date(a.zur√ºckgegeben));
          for (const eintrag of alleEintraege[nummer]) {
            function formatZeit(datum) {
              const date = new Date(datum);
              const tag = String(date.getDate()).padStart(2, '0');
              const monat = String(date.getMonth() + 1).padStart(2, '0');
              const stunde = String(date.getHours()).padStart(2, '0');
              const minute = String(date.getMinutes()).padStart(2, '0');
              return `${tag}.${monat} ‚Äì ${stunde}:${minute}`;
            }
            const aus = formatZeit(eintrag.ausgeliehen);
            const zr = formatZeit(eintrag.zur√ºckgegeben);
            const zeile = document.createElement("div");
            zeile.innerHTML = `‚Ä¢ ${eintrag.kind}: von ${aus} bis ${zr} <span class="delete" onclick="loescheHistorie('${eintrag.kind}', '${eintrag.key}')">x</span>`;
            box.appendChild(zeile);
          }
          historieListe.appendChild(box);
        }
      });
    }

    window.loescheHistorie = function(name, key) {
      if (confirm(`Eintrag von ${name} wirklich l√∂schen?`)) {
        remove(ref1(db1, `historie/${name}/${key}`));
      }
    };

    function ladeKontoLoeschen() {
      const liste = document.getElementById("konto-loeschen-liste");
      onVal2(ref2(db2, "kinder"), snapshot => {
        liste.innerHTML = "";
        snapshot.forEach(child => {
          const name = child.key;
          const div = document.createElement("div");
          div.innerHTML = `${name} <span class="delete" onclick="loescheKonto('${name}')">x</span>`;
          liste.appendChild(div);
        });
      });
    }

    window.loescheKonto = function(name) {
      if (confirm(`Konto von ${name} wirklich l√∂schen?`)) {
        remove2(ref2(db2, "kinder/" + name)).catch(err => console.error("Fehler MausCity:", err));
        remove(ref1(db1, "kinder/" + name)).catch(err => console.error("Fehler AdminDB:", err));
      }
    };
  </script>
</head>
<body>
  <h1>Adminbereich</h1>

  <div class="section">
    <h2>Mausdollar Anfragen</h2>
    <div class="liste" id="mausdollar-anfragen-liste"></div>
  </div>

  <div class="section">
    <h2>Aktuelle Ausleihen</h2>
    <div class="liste" id="ausleihen-liste"></div>
  </div>

  <div class="section">
    <h2>MausCity Konten</h2>
    <div class="liste" id="mauscity-konten-liste"></div>
  </div>

  <div class="section">
    <h2>Kinder hinzuf√ºgen</h2>
    <div class="form-group">
      <input id="kind-name" type="text" placeholder="Name des Kindes" />
      <input id="checkout-link" type="text" placeholder="Checkout-Link (optional)" />
      <input id="security-code" type="text" placeholder="3-stelliger Code" />
    </div>
    <div class="checkboxes">
      <label><input type="checkbox" id="ist-gruppen"> Gruppenkonto hinzuf√ºgen</label>
      <label><input type="checkbox" id="ist-ausland"> Auslandskonto hinzuf√ºgen</label>
    </div>
    <button id="add-kind-btn">Hinzuf√ºgen</button>
    <div class="liste" id="kinder-liste"></div>
  </div>

  <div class="section">
    <h2>Spielzeuge hinzuf√ºgen</h2>
    <div class="form-group inline">
      <input id="spielzeug-nummer" type="text" placeholder="Nummer" style="width: 100px;"/>
      <input id="spielzeug-name" type="text" placeholder="Spielzeugname" style="flex-grow: 1;"/>
      <button id="add-spielzeug-btn">Hinzuf√ºgen</button>
    </div>
    <div class="liste" id="spielzeug-liste"></div>
  </div>

  <div class="section">
    <h2>Historie</h2>
    <div class="liste" id="historie-liste"></div>
  </div>
  
  <div class="section">
    <h2>Konto l√∂schen</h2>
    <div class="liste" id="konto-loeschen-liste"></div>
  </div>
</body>
</html>

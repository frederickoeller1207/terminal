<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Admin ‚Äì M√§usegruppe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007aff;
      --primary-hover-color: #005bb5;
      --background-color: #f4f4f4;
      --card-background-color: #fff;
      --text-color: #333;
      --border-radius: 12px;
      --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      --font-size-small: 14px;
      --font-size-medium: 16px;
    }
    body { font-family: 'SF Pro Display', sans-serif; padding: 15px; background-color: var(--background-color); color: var(--text-color); font-size: var(--font-size-medium); line-height: 1.6; }
    h1 { font-size: 22px; margin-bottom: 20px; text-align: center; font-weight: 600; color: var(--primary-color); }
    h2 { font-size: 18px; margin: 0 0 15px 0; font-weight: 600; }
    input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: var(--font-size-small); width: 100%; box-sizing: border-box; }
    button { padding: 8px 14px; font-size: var(--font-size-small); background-color: var(--primary-color); color: white; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s ease; font-weight: 600; white-space: nowrap; }
    button.secondary { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
    button.secondary:hover { background-color: #e0e0e0; }
    button:hover { background-color: var(--primary-hover-color); }
    .section { background: var(--card-background-color); padding: 15px; margin-bottom: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
    .liste { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .liste > div { padding: 10px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .liste > div:last-child { border-bottom: none; }
    .delete { color: #ff3b30; cursor: pointer; margin-left: 10px; font-weight: 600; font-size: var(--font-size-small); }
    .delete:hover { text-decoration: underline; }
    .flex { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
    .flex-buttons { display: flex; gap: 5px; align-items: center; }
    .color-button { border: 1px solid #ccc; border-radius: 5px; padding: 2px 5px; font-size: 16px; cursor: pointer; transition: all 0.2s ease; background:#fff; }
    .color-button:hover { transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .small-button { padding: 4px 8px; font-size: 12px; border-radius: 8px; background:#fff; color:#333; border:1px solid #ccc; }
    .shop-admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .action-buttons { display: flex; gap: 5px; flex-grow: 1; justify-content: flex-end; }
    .action-button { padding: 8px 12px; border-radius: 8px; border: none; color: white; font-weight: 600; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
    .action-button.execute { background-color: var(--primary-color); }
    .action-button.execute:hover { background-color: var(--primary-hover-color); }
    .action-button.white { background-color: #fff; color: #333; border: 1px solid #ccc; }
    .action-button.white:hover { background-color: #f0f0f0; }
    .action-button.green { background-color: #28a745; }
    .action-button.green:hover { background-color: #218838; }
    .callout { background:#fff7ed; border:1px solid #fed7aa; border-radius:10px; padding:10px; }
    .z-btn { margin-left: 6px; font-size: 12px; cursor: pointer; color: #007aff; font-weight: bold; }
    /* Inputs for Kurznachrichten */
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row > * { flex:1 1 220px; }
    select, input[type="datetime-local"] { padding:8px; border:1px solid #ddd; border-radius:8px; font-size:var(--font-size-small); width:100%; box-sizing:border-box; }
  </style>

  <script type="module">
    /* Firebase Imports */
    import { initializeApp as initApp1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB1, ref as ref1, set, onValue, remove, get, push } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB2, ref as ref2, get as get2, update as update2, onValue as onVal2, remove as remove2, set as set2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    import { initializeApp as initApp3 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB3, ref as ref3, onValue as onVal3, update as update3, remove as remove3, get as get3 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    /* Apps */
    const app1 = initApp1({
      apiKey: "AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
      authDomain: "gesamt-dae4e.firebaseapp.com",
      databaseURL: "https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gesamt-dae4e",
      storageBucket: "gesamt-dae4e.appspot.com",
      messagingSenderId: "844023612743",
      appId: "1:844023612743:web:0821aa894541f89a7df862"
    }, "app1");
    const db1 = getDB1(app1);

    const app2 = initApp2({
      apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      authDomain: "punkte-45c20.firebaseapp.com",
      databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "punkte-45c20",
      storageBucket: "punkte-45c20.appspot.com",
      messagingSenderId: "931713539549",
      appId: "1:931713539549:web:e348bf38369639f1906a34"
    }, "app2");
    const db2 = getDB2(app2);

    const app3 = initApp3({
      apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
    }, "app3");
    const db3 = getDB3(app3);

    /* Farben und Mappings */
    const farben = ["‚ö™", "üî¥", "üü°", "üü¢", "‚ö´", "üü£"];
    function farbeToColor(f) {
      if (f === "üî¥") return "red";
      if (f === "üü°") return "orange";
      if (f === "üü¢") return "green";
      if (f === "‚ö´") return "black";
      if (f === "üü£") return "purple";
      return "#333";
    }
    function colorToDelta(f){
      if (f==="üü¢") return 5;
      if (f==="üü£") return 10;
      if (f==="üî¥") return -5;
      if (f==="‚ö´") return -10;
      return 0; // üü°, ‚ö™
    }
    const clamp01 = x => Math.max(0, Math.min(100, x|0));

    /* Ziele-Cache und Z-Button */
    let GOALS_CACHE = null;
    async function ladeZieleMeta(){
      if (GOALS_CACHE) return GOALS_CACHE;
      const snap = await get2(ref2(db2, "ziele/meta"));
      GOALS_CACHE = (snap.exists() && Array.isArray(snap.val())) ? snap.val() : [];
      return GOALS_CACHE;
    }
    window.zeigeAktivesZiel = async function(name){
      try {
        const [kidSnap, goals] = await Promise.all([
          get2(ref2(db2, `kinder/${name}`)),
          ladeZieleMeta()
        ]);
        if (!kidSnap.exists()) { alert("Kein Datensatz gefunden."); return; }
        const v = kidSnap.val() || {};
        if (v.farbe === undefined) { alert("Dieses Konto hat keine Farbe und kein Ziel."); return; }
        const idx = Math.max(0, Math.min((goals.length||1)-1, (v.activeGoalIndex ?? 0)|0));
        const titel = goals[idx] || "‚Äî";
        alert(`Aktives Ziel f√ºr ${name}\n\nZiel ${idx+1}: ${titel}\nFortschritt: ${v.progress||0}%`);
      } catch(e){
        console.error(e);
        alert("Fehler beim Laden des Ziels.");
      }
    };

    /* Meilenstein-Logik: nur neue, h√∂here Marken */
    async function rewardMilestonesAndMaybeComplete(name, kid, newProgress){
      let saldo = kid.punkte || 0;
      let last  = kid.lastRewardedMilestone ?? 0;

      const capped = Math.min(newProgress, 100);
      const from = Math.floor(Math.max(last,0)/10);
      const to   = Math.floor(capped/10);

      if (to > from){
        for(let m=from+1; m<=to && m<10; m++){ // 10..90 % je einmal
          saldo += 1; last = m*10;
        }
      }

      if (capped >= 100){
        if (last < 100){ saldo += 1; last = 100; } // 100 % je einmal
        await update2(ref2(db2, `kinder/${name}`), {
          punkte: saldo,
          progress: 100,
          lastRewardedMilestone: 100,
          needsGoalAssignment: true,
          farbe: "‚ö™"
        });
        renderAbschluesse();
      } else {
        await update2(ref2(db2, `kinder/${name}`), {
          punkte: saldo,
          lastRewardedMilestone: last,
          progress: clamp01(capped),
          farbe: "‚ö™"
        });
      }
    }

    /* Durchf√ºhren: Farben ‚Üí Prozent anwenden */
    async function durchfuehren() {
      const snapshot = await get2(ref2(db2, "kinder"));
      const ops = [];
      snapshot.forEach(childSnap => {
        const name = childSnap.key;
        const kid = childSnap.val() || {};
        if (kid.farbe === undefined) return; // Auslandskonto √ºberspringen
        const newP = clamp01((kid.progress ?? 0) + colorToDelta(kid.farbe));
        ops.push(rewardMilestonesAndMaybeComplete(name, {
          punkte: kid.punkte || 0,
          farbe: kid.farbe,
          activeGoalIndex: kid.activeGoalIndex ?? 0,
          progress: kid.progress ?? 0,
          lastRewardedMilestone: kid.lastRewardedMilestone ?? 0
        }, newP));
      });
      await Promise.all(ops);
      renderAbschluesse();
    }

    /* Abschl√ºsse warten: dynamisch sichtbar */
    async function renderAbschluesse(){
      const section = document.getElementById("abschluss-section");
      const box = document.getElementById("abschluss-wartend");
      box.innerHTML = "";
      let count = 0;

      const [kSnap, goals] = await Promise.all([
        get2(ref2(db2, "kinder")), ladeZieleMeta()
      ]);
      if (kSnap.exists()){
        kSnap.forEach(ch=>{
          const name = ch.key;
          const v = ch.val()||{};
          if (v.farbe === undefined) return;
          if (v.progress === 100 && v.needsGoalAssignment){
            const zielTitel = goals[(v.activeGoalIndex ?? 0)] || "‚Äî";
            const row = document.createElement("div");
            row.className = "flex";
            row.innerHTML = `
              <div><b>${name}</b> hat 100 % erreicht ‚Äì ‚Äû${zielTitel}‚Äú.</div>
              <div class="flex-buttons">
                <button class="small-button" onclick="vergebeFinale5('${name}')">Bonus +5</button>
                <button class="small-button" onclick="naechstesZiel('${name}')">N√§chstes Ziel</button>
              </div>`;
            box.appendChild(row);
            count++;
          }
        });
      }
      section.style.display = count > 0 ? "block" : "none";
    }

    /* Bonus +5 manuell */
    window.vergebeFinale5 = async function(name){
      const s = await get2(ref2(db2, `kinder/${name}`));
      if (!s.exists()) return;
      const v = s.val()||{};
      await update2(ref2(db2, `kinder/${name}`), { punkte: (v.punkte||0) + 5 });
      alert(`${name}: +5 Mausdollar vergeben.`);
      renderAbschluesse();
    };

    /* N√§chstes Ziel manuell setzen (Index +1) */
    window.naechstesZiel = async function(name){
      const s = await get2(ref2(db2, `kinder/${name}`));
      if (!s.exists()) return;
      const v = s.val()||{};
      const goals = await ladeZieleMeta();
      const nextIdx = Math.min((goals.length?goals.length:1)-1, (v.activeGoalIndex ?? 0) + 1);
      await update2(ref2(db2, `kinder/${name}`), {
        activeGoalIndex: nextIdx,
        progress: 0,
        lastRewardedMilestone: 0,
        needsGoalAssignment: false
      });
      alert(`${name}: auf n√§chstes Ziel gesetzt.`);
      renderAbschluesse();
    };

    /* MausCity-Konten rendern (mit Z-Button und Farbauswahl) */
    function ladeKinderKonten() {
      const bereich = document.getElementById("mauscity-konten-liste");
      const eigeneKinder = new Set();
      onValue(ref1(db1, "kinder"), (snapshot) => {
        eigeneKinder.clear();
        snapshot.forEach(childSnap => { eigeneKinder.add(childSnap.key); });
        onVal2(ref2(db2, "kinder"), (snapshot2) => {
          bereich.innerHTML = "";
          snapshot2.forEach(childSnap2 => {
            const name = childSnap2.key;
            const data = childSnap2.val();
            if (!eigeneKinder.has(name)) return;

            const zeile = document.createElement("div");
            zeile.className = "flex";

            const kontoInfo = document.createElement("div");
            kontoInfo.innerHTML =
              `<span style="color:${farbeToColor(data.farbe)};font-weight:bold;">${name}</span>
               (<span style="color:${farbeToColor(data.farbe)};font-weight:bold;">${data.punkte || 0}</span>)
               <button class="small-button" title="Aktives Ziel zeigen" onclick="zeigeAktivesZiel('${name}')">Z</button>`;

            const punkteButtons = document.createElement("div");
            punkteButtons.className = "flex-buttons";
            const plus = document.createElement("button");
            plus.textContent = "+";
            plus.onclick = () => update2(ref2(db2, `kinder/${name}`), { punkte: (data.punkte || 0) + 1 });
            const minus = document.createElement("button");
            minus.textContent = "‚Äì";
            minus.onclick = () => update2(ref2(db2, `kinder/${name}`), { punkte: (data.punkte || 0) - 1 });
            punkteButtons.appendChild(plus);
            punkteButtons.appendChild(minus);

            zeile.appendChild(kontoInfo);
            zeile.appendChild(punkteButtons);

            if (!name.includes("~")) {
              const farbButtons = document.createElement("div");
              farbButtons.className = "flex-buttons";
              farben.forEach(f => {
                const btn = document.createElement("button");
                btn.textContent = f;
                btn.className = "color-button";
                btn.title = "Farbe setzen";
                btn.onclick = () => update2(ref2(db2, `kinder/${name}`), { farbe: f });
                farbButtons.appendChild(btn);
              });
              zeile.appendChild(farbButtons);
            }
            bereich.appendChild(zeile);
          });
        });
      });
    }

    /* Sammel-Aktionen Farben */
    async function alleAufGruen() {
      const snapshot = await get2(ref2(db2, "kinder"));
      snapshot.forEach(childSnap => {
        const name = childSnap.key;
        const data = childSnap.val();
        if (data.farbe !== undefined) {
          update2(ref2(db2, `kinder/${name}`), { farbe: "üü¢" });
        }
      });
    }
    async function alleAufWeiss() {
      const snapshot = await get2(ref2(db2, "kinder"));
      snapshot.forEach(childSnap => {
        const name = childSnap.key;
        const data = childSnap.val();
        if (data.farbe !== undefined) {
          update2(ref2(db2, `kinder/${name}`), { farbe: "‚ö™" });
        }
      });
    }

    /* Shop-Bestellungen */
    function ladeShopBestellungen() {
      const pendingOrdersList = document.getElementById('pending-orders-list');
      const ordersRef = ref3(db3, 'bestellungen');
      onVal3(ordersRef, (snapshot) => {
          pendingOrdersList.innerHTML = '';
          const orders = snapshot.val();
          if (orders) {
              Object.keys(orders).forEach(key => {
                  const order = orders[key];
                  if (order.status === 'wird geliefert') {
                      const li = document.createElement('div');
                      li.className = 'request-item';
                      li.innerHTML = `
                          <div class="request-info">
                              <strong>${order.name}</strong> hat "${order.artikel}" bestellt.<br>
                              <small>Kaufpreis: ${order.gezahlterPreis} Mausdollar, Datum: ${new Date(order.kaufdatum).toLocaleDateString()}</small>
                          </div>
                          <div class="flex-buttons">
                              <button class="confirm-delivery-btn" data-id="${key}" data-user-type="${order.userType}" data-user-name="${order.name}" data-item-name="${order.artikel}">‚úîÔ∏è</button>
                              <button class="reject-purchase-btn" data-id="${key}" data-user-type="${order.userType}" data-user-name="${order.name}" data-price="${order.gezahlterPreis}">‚ùå</button>
                          </div>
                      `;
                      pendingOrdersList.appendChild(li);
                  }
              });
          }
      });

      pendingOrdersList?.addEventListener('click', async (e) => {
        const orderId = e.target.dataset.id;
        const userType = e.target.dataset.userType;
        const userName = e.target.dataset.userName;
        const price = parseFloat(e.target.dataset.price);

        if (e.target.classList.contains('confirm-delivery-btn')) {
            const itemName = e.target.dataset.itemName;
            update3(ref3(db3, `bestellungen/${orderId}`), { status: 'Produkt geliefert' });
            alert(`Bestellung von ${userName} (${itemName}) als geliefert markiert.`);
        } else if (e.target.classList.contains('reject-purchase-btn')) {
            const userRef = ref3(db3, `${userType}/${userName}`);
            const userSnap = await get3(userRef);
            const user = userSnap.val();
            if (user) {
                const newPoints = (user.punkte || 0) + price;
                update3(ref3(db3, `${userType}/${userName}`), { punkte: newPoints });
            }
            update3(ref3(db3, `bestellungen/${orderId}`), { status: 'Kauf abgelehnt' });
            alert(`Kauf von ${userName} abgelehnt. ${price} Mausdollar wurden erstattet.`);
        }
      });
    }

    /* Mausdollar Anfragen */
    function ladeMausdollarAnfragen() {
      const container = document.getElementById("mausdollar-anfragen-liste");
      onValue(ref1(db1, "anfragen"), (snapshot) => {
        container.innerHTML = "";
        snapshot.forEach(childSnap => {
          const id = childSnap.key;
          const data = childSnap.val();
          const zeile = document.createElement("div");
          zeile.className = "request-item";
          zeile.innerHTML = `
            <div class="request-info">${data.name} m√∂chte ${data.betrag} Punkt(e) wegen **${data.grund}**</div>
            <div class="flex-buttons">
              <button onclick="bestaetigeAnfrage('${id}', '${data.name}', ${data.betrag})">‚úîÔ∏è</button>
              <button onclick="lehneAnfrage('${id}')">‚ùå</button>
            </div>
          `;
          container.appendChild(zeile);
        });
      });
    }
    window.bestaetigeAnfrage = async function(id, name, betrag) {
      const kindRef = ref2(db2, `kinder/${name}`);
      const kindSnap = await get2(kindRef);
      const val = kindSnap.val() || { punkte: 0, farbe: "‚ö™" };
      await update2(kindRef, { punkte: val.punkte + betrag });
      remove(ref1(db1, "anfragen/" + id));
    };
    window.lehneAnfrage = function(id) { remove(ref1(db1, "anfragen/" + id)); };

    /* Ausleihen */
    function ladeAktuelleAusleihen() {
      const ausleihenListe = document.getElementById("ausleihen-liste");
      onValue(ref1(db1, "ausleihen"), (snapshot) => {
        ausleihenListe.innerHTML = "";
        snapshot.forEach(childSnap => {
          const name = childSnap.key;
          const daten = childSnap.val();
          const div = document.createElement("div");
          div.className = "flex";
          div.innerHTML = `<b>${name}</b> hat <i>${daten.spielzeug}</i> ausgeliehen`;
          const button = document.createElement("button");
          button.textContent = "Zur√ºckgeben";
          button.onclick = () => zurueckgeben(name);
          div.appendChild(button);
          ausleihenListe.appendChild(div);
        });
      });
    }
    window.zurueckgeben = async function(name) {
      const ausleiheRef = ref1(db1, "ausleihen/" + name);
      const snapshot = await get(ausleiheRef);
      if (!snapshot.exists()) return;
      const daten = snapshot.val();
      const historieRef = ref1(db1, "historie/" + name);
      const neueHistorie = { spielzeug: daten.spielzeug, nummer: daten.nummer, ausgeliehen: daten.zeit, zur√ºckgegeben: new Date().toISOString() };
      const neueRef = push(historieRef);
      await set(neueRef, neueHistorie);
      await remove(ausleiheRef);
    };

    /* Kinder hinzuf√ºgen */
    function ladeKinderHinzufuegen() {
      const addKindBtn = document.getElementById("add-kind-btn");
      addKindBtn.onclick = () => {
        const name = document.getElementById("kind-name").value.trim();
        let link = document.getElementById("checkout-link").value.trim();
        const code = document.getElementById("security-code").value.trim();
        const istGruppenkonto = document.getElementById("ist-gruppen")?.checked;
        const istAuslandskonto = document.getElementById("ist-ausland")?.checked;

        if (!name || !code) return alert("Name und Sicherheitscode sind erforderlich.");
        if (link && !link.startsWith("http")) link = "https://" + link;

        set(ref1(db1, `kinder/${name}`), { link: link || null, code });

        if (istGruppenkonto) {
          set2(ref2(db2, `kinder/${name}`), { punkte: 0, farbe: "‚ö™" });
        } else if (istAuslandskonto) {
          set2(ref2(db2, `kinder/${name}`), { punkte: 0 });
        }

        document.getElementById("kind-name").value = "";
        document.getElementById("checkout-link").value = "";
        document.getElementById("security-code").value = "";
        if (document.getElementById("ist-gruppen")) document.getElementById("ist-gruppen").checked = false;
        if (document.getElementById("ist-ausland")) document.getElementById("ist-ausland").checked = false;
      };

      const kinderListe = document.getElementById("kinder-liste");
      onValue(ref1(db1, "kinder"), (snapshot) => {
        kinderListe.innerHTML = "";
        snapshot.forEach(childSnap => {
          const name = childSnap.key;
          const data = childSnap.val();
          const div = document.createElement("div");
          div.innerHTML = `${name} ‚Äì Link: ${data.link || "kein Link"} ‚Äì Code: ${data.code || "kein Code"} <span class="delete" onclick="loescheKind('${name}')">x</span>`;
          kinderListe.appendChild(div);
        });
      });
    }
    window.loescheKind = function(name) {
      if (confirm(`Soll ${name} wirklich gel√∂scht werden?`)) {
        remove(ref1(db1, "kinder/" + name));
      }
    };

    /* Spielzeuge */
    function ladeSpielzeugeHinzufuegen() {
      const addSpielzeugBtn = document.getElementById("add-spielzeug-btn");
      addSpielzeugBtn.onclick = () => {
        const nummer = document.getElementById("spielzeug-nummer").value.trim();
        const name = document.getElementById("spielzeug-name").value.trim();
        if (!nummer || !name) return alert("Nummer oder Name fehlt.");
        set(ref1(db1, `spielzeuge/${nummer}`), name);
        document.getElementById("spielzeug-nummer").value = "";
        document.getElementById("spielzeug-name").value = "";
      };

      const spielzeugListe = document.getElementById("spielzeug-liste");
      onValue(ref1(db1, "spielzeuge"), (snapshot) => {
        spielzeugListe.innerHTML = "";
        snapshot.forEach(childSnap => {
          const nummer = childSnap.key;
          const name = childSnap.val();
          const div = document.createElement("div");
          div.innerHTML = `${nummer}: ${name} <span class="delete" onclick="loescheSpielzeug('${nummer}')">x</span>`;
          spielzeugListe.appendChild(div);
        });
      });
    }
    window.loescheSpielzeug = function(nummer) {
      if (confirm(`Soll Spielzeug ${nummer} wirklich gel√∂scht werden?`)) {
        remove(ref1(db1, "spielzeuge/" + nummer));
      }
    };

    /* Historie */
    function ladeHistorie() {
      const historieListe = document.getElementById("historie-liste");
      onValue(ref1(db1, "historie"), async (snapshot) => {
        historieListe.innerHTML = "";
        const alleEintraege = {};
        snapshot.forEach(childSnap => {
          const kind = childSnap.key;
          const eintraege = childSnap.val();
          for (const key in eintraege) {
            const eintrag = eintraege[key];
            const nummer = eintrag.nummer;
            if (!alleEintraege[nummer]) alleEintraege[nummer] = [];
            alleEintraege[nummer].push({ ...eintrag, kind, key });
          }
        });
        const sortierteNummern = Object.keys(alleEintraege).sort((a, b) => Number(a) - Number(b));
        for (const nummer of sortierteNummern) {
          const box = document.createElement("div");
          const nameRef = ref1(db1, "spielzeuge/" + nummer);
          const nameSnap = await get(nameRef);
          const name = nameSnap.exists() ? nameSnap.val() : "Unbekannt";
          box.innerHTML = `<h3>${nummer}: ${name}</h3>`;
          alleEintraege[nummer].sort((a, b) => new Date(b.zur√ºckgegeben) - new Date(a.zur√ºckgegeben));
          for (const eintrag of alleEintraege[nummer]) {
            function formatZeit(datum) {
              const date = new Date(datum);
              const tag = String(date.getDate()).padStart(2, '0');
              const monat = String(date.getMonth() + 1).padStart(2, '0');
              const stunde = String(date.getHours()).padStart(2, '0');
              const minute = String(date.getMinutes()).padStart(2, '0');
              return `${tag}.${monat} ‚Äì ${stunde}:${minute}`;
            }
            const aus = formatZeit(eintrag.ausgeliehen);
            const zr = formatZeit(eintrag.zur√ºckgegeben);
            const zeile = document.createElement("div");
            zeile.innerHTML = `‚Ä¢ ${eintrag.kind}: von ${aus} bis ${zr} <span class="delete" onclick="loescheHistorie('${eintrag.kind}', '${eintrag.key}')">x</span>`;
            box.appendChild(zeile);
          }
          historieListe.appendChild(box);
        }
      });
    }
    window.loescheHistorie = function(name, key) {
      if (confirm(`Eintrag von ${name} wirklich l√∂schen?`)) {
        remove(ref1(db1, `historie/${name}/${key}`));
      }
    };

    /* Konten l√∂schen */
    function ladeKontoLoeschen() {
      const liste = document.getElementById("konto-loeschen-liste");
      onVal2(ref2(db2, "kinder"), snapshot => {
        liste.innerHTML = "";
        snapshot.forEach(child => {
          const name = child.key;
          const div = document.createElement("div");
          div.innerHTML = `${name} <span class="delete" onclick="loescheKonto('${name}')">x</span>`;
          liste.appendChild(div);
        });
      });
    }
    window.loescheKonto = function(name) {
      if (confirm(`Konto von ${name} wirklich l√∂schen?`)) {
        remove2(ref2(db2, "kinder/" + name)).catch(err => console.error("Fehler MausCity:", err));
        remove(ref1(db1, "kinder/" + name)).catch(err => console.error("Fehler AdminDB:", err));
      }
    };

    /* ===== NEU: Kurznachrichten verwalten (db1/kurznachrichten) ===== */
    function ladeKurznachrichten() {
      const addBtn = document.getElementById("add-notice-btn");
      if (addBtn) {
        addBtn.onclick = () => {
          const title = document.getElementById("notice-title").value.trim();
          const text = document.getElementById("notice-text").value.trim();
          const color = document.getElementById("notice-color").value;
          const startISO = document.getElementById("notice-start").value; // datetime-local
          const endISO = document.getElementById("notice-end").value;
          if (!text || !startISO || !endISO) { alert("Text, Start- und Endzeit sind erforderlich."); return; }

          const id = Date.now();
          set(ref1(db1, `kurznachrichten/${id}`), {
            title, text, color, startISO, endISO, createdAt: id
          });

          document.getElementById("notice-title").value = "";
          document.getElementById("notice-text").value = "";
          document.getElementById("notice-start").value = "";
          document.getElementById("notice-end").value = "";
        };
      }

      const list = document.getElementById("kurznachrichten-liste");
      if (list) {
        onValue(ref1(db1, "kurznachrichten"), snap => {
          list.innerHTML = "";
          if (snap.exists()) {
            const arr = [];
            snap.forEach(ch => arr.push({ id: ch.key, ...ch.val() }));
            arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
            arr.forEach(n => {
              const div = document.createElement("div");
              div.className = "flex";
              const label = (n.title && n.title.trim()) ? n.title : "Nachricht";
              div.innerHTML = `<div><b>${label}</b>: ${n.text} <small>[${n.color}]</small></div>
                               <span class="delete" onclick="loescheNotice('${n.id}')">x</span>`;
              list.appendChild(div);
            });
          }
        });
      }
    }
    window.loescheNotice = function(id){
      if (confirm("Nachricht wirklich l√∂schen?")) {
        remove(ref1(db1, "kurznachrichten/" + id));
      }
    };

    /* Init */
    window.addEventListener("DOMContentLoaded", () => {
      // Shop, Anfragen, Ausleihen
      ladeShopBestellungen();
      ladeMausdollarAnfragen();
      ladeAktuelleAusleihen();

      // MausCity Konten + Buttons
      ladeKinderKonten();
      document.getElementById('durchfuehren-btn')?.addEventListener('click', async ()=>{ await durchfuehren(); });
      document.getElementById('alle-gruen-btn')?.addEventListener('click', alleAufGruen);
      document.getElementById('alle-weiss-btn')?.addEventListener('click', alleAufWeiss);

      // Abschl√ºsse
      renderAbschluesse();

      // Kinder/Spielzeug, Historie, Konto l√∂schen
      ladeKinderHinzufuegen();
      ladeSpielzeugeHinzufuegen();
      ladeHistorie();
      ladeKontoLoeschen();

      // NEU: Kurznachrichten
      ladeKurznachrichten();
    });
  </script>
</head>
<body>
  <h1>Adminbereich</h1>

  <div class="section">
    <div class="shop-admin-header">
      <h2>Shop Bestellungen</h2>
      <a href="https://frederickoeller1207.github.io/Mousecity-Store/admin" target="_blank">
        <button class="secondary">Zur Shop Administration</button>
      </a>
    </div>
    <div class="liste" id="pending-orders-list"></div>
  </div>

  <div class="section">
    <h2>Mausdollar Anfragen</h2>
    <div class="liste" id="mausdollar-anfragen-liste"></div>
  </div>

  <div class="section">
    <h2>Aktuelle Ausleihen</h2>
    <div class="liste" id="ausleihen-liste"></div>
  </div>

  <!-- Dynamisch sichtbar -->
  <div class="section" id="abschluss-section" style="display:none">
    <h2>Abschl√ºsse warten auf Freigabe</h2>
    <div class="liste callout" id="abschluss-wartend"></div>
  </div>

  <div class="section">
    <div class="shop-admin-header">
      <h2>MausCity Konten</h2>
      <div class="action-buttons">
        <button id="durchfuehren-btn" class="action-button execute" title="Farben ‚Üí Ziel-Fortschritt anwenden">‚úîÔ∏è</button>
        <button id="alle-gruen-btn" class="action-button green" title="Alle auf Gr√ºn setzen">Alle</button>
        <button id="alle-weiss-btn" class="action-button white" title="Alle auf Wei√ü setzen">Alle</button>
      </div>
    </div>
    <div class="liste" id="mauscity-konten-liste"></div>
  </div>

  <!-- NEU: Kurznachrichten (unter den MausCity Konten) -->
  <div class="section">
    <h2>Kurznachrichten</h2>
    <div class="row">
      <input id="notice-title" type="text" placeholder="Titel (optional, z. B. Nachricht)" />
      <input id="notice-text" type="text" placeholder="Nachrichtentext" />
    </div>
    <div class="row">
      <select id="notice-color" aria-label="Farbe">
        <option value="blue">Blau</option>
        <option value="red">Rot</option>
        <option value="green">Gr√ºn</option>
        <option value="orange">Orange</option>
        <option value="purple">Lila</option>
        <option value="black">Schwarz</option>
        <option value="gray">Grau</option>
      </select>
      <input id="notice-start" type="datetime-local" aria-label="Start" />
      <input id="notice-end" type="datetime-local" aria-label="Ende" />
    </div>
    <button id="add-notice-btn">Neue Kurznachricht hinzuf√ºgen</button>
    <div class="liste" id="kurznachrichten-liste"></div>
  </div>

  <div class="section">
    <h2>Kinder hinzuf√ºgen</h2>
    <div class="form-group">
      <input id="kind-name" type="text" placeholder="Name des Kindes" />
      <input id="checkout-link" type="text" placeholder="Checkout-Link (optional)" />
      <input id="security-code" type="text" placeholder="3-stelliger Code" />
    </div>
    <div class="checkboxes">
      <label><input type="checkbox" id="ist-gruppen"> Gruppenkonto hinzuf√ºgen</label>
      <label><input type="checkbox" id="ist-ausland"> Auslandskonto hinzuf√ºgen</label>
    </div>
    <button id="add-kind-btn">Hinzuf√ºgen</button>
    <div class="liste" id="kinder-liste"></div>
  </div>

  <div class="section">
    <h2>Spielzeuge hinzuf√ºgen</h2>
    <div class="form-group inline">
      <input id="spielzeug-nummer" type="text" placeholder="Nummer" style="width: 100px;"/>
      <input id="spielzeug-name" type="text" placeholder="Spielzeugname" style="flex-grow: 1;"/>
      <button id="add-spielzeug-btn">Hinzuf√ºgen</button>
    </div>
    <div class="liste" id="spielzeug-liste"></div>
  </div>

  <div class="section">
    <h2>Historie</h2>
    <div class="liste" id="historie-liste"></div>
  </div>
  
  <div class="section">
    <h2>Konto l√∂schen</h2>
    <div class="liste" id="konto-loeschen-liste"></div>
  </div>
</body>
</html>
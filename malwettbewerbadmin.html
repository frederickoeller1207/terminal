<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Malwettbewerb – Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#007aff; --primary2:#005bb5; --bg:#f4f6f8; --card:#fff; --ink:#1f2328;
      --muted:#667085; --danger:#ff3b30; --ring:0 8px 30px rgba(16,24,40,.08)
    }
    *{box-sizing:border-box}
    body{font-family:'SF Pro Display',sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:16px}
    h1{margin:6px 0 16px 0;font-size:26px}
    h2{font-size:20px;margin:0 0 12px 0}
    .section{background:var(--card);border-radius:14px;box-shadow:var(--ring);padding:16px;margin-bottom:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,input[type="text"],input[type="datetime-local"]{width:100%;max-width:360px;padding:10px 12px;border:1px solid #d0d5dd;border-radius:10px;font-size:15px}
    button{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.secondary{background:#fff;color:#111;border:1px solid #d0d5dd}
    button.danger{background:var(--danger)}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{display:flex;gap:12px;align-items:center;background:#fff;border:1px solid #eee;border-radius:12px;padding:10px}
    .thumb{width:48px;height:48px;flex:0 0 48px;border-radius:8px;object-fit:cover;background:#f2f2f2}
    .spacer{flex:1}
    .muted{color:var(--muted);font-size:14px}
    .badge{background:#eef2ff;color:#344054;border-radius:999px;padding:4px 10px;font-weight:800;font-size:13px}
    .grid-2{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){.grid-2{grid-template-columns:1fr 1fr}}
    .toggle{display:flex;gap:8px;align-items:center}
    /* Modal für Wählerliste */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:80}
    .dialog{background:#fff;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,.35);width:min(92vw,520px);padding:16px}
    .dialog h3{margin:0 0 10px 0}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#f2f4f7;border:1px solid #e4e7ec;border-radius:999px;padding:6px 10px;font-weight:700}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase, ref, onValue, get, set, update, remove, push } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    // DB: punkte (alles vom Malwettbewerb)
    const app = initializeApp({
      apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
    }, "punkte");
    const db = getDatabase(app);

    const ns = "malwettbewerb";

    // UI refs
    const el = (id)=>document.getElementById(id);

    let alleWettbewerbe = {};   // {id:{phasen, bilder, gewinner}}
    let aktuelleId = null;

    // Util: datetime-local ⇄ ISO
    const toLocalValue = (iso)=> {
      if(!iso) return "";
      const d = new Date(iso);
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const fromLocalValue = (val)=> val ? new Date(val).toISOString() : null;

    // Util: Key-Encoding wie Kinderseite
    const decodeKey = (k)=> k.replaceAll("_","/");
    const encodeKey = (k)=> k.replaceAll("/","_");

    // Init
    window.addEventListener("DOMContentLoaded", async ()=>{
      // akt. ID
      onValue(ref(db, `${ns}/aktuelleId`), s=>{
        aktuelleId = s.exists()? s.val() : null;
        renderAktuelleIdSelect();
        renderAlles();
      });

      // alle Wettbewerbe
      onValue(ref(db, `${ns}/wettbewerbe`), s=>{
        alleWettbewerbe = s.val() || {};
        renderAktuelleIdSelect();
        renderAlles();
      });

      // Zähler-Einstellung laden
      onValue(ref(db, `${ns}/einstellungen/zeigeZaehler`), s=>{
        el("toggleZaehler").checked = !!(s.exists()? s.val(): false);
      });
    });

    // Render: Auswahl aktuelle ID
    function renderAktuelleIdSelect(){
      const sel = el("aktSel");
      const ids = Object.keys(alleWettbewerbe||{});
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "— auswählen —";
      sel.appendChild(opt0);
      ids.sort().forEach(id=>{
        const o = document.createElement("option");
        o.value = id;
        o.textContent = id;
        if(aktuelleId === id) o.selected = true;
        sel.appendChild(o);
      });
      el("setAktivBtn").disabled = sel.value==="";
    }

    // Setze aktuelle ID
    el("setAktivBtn").onclick = async ()=>{
      const id = el("aktSel").value;
      if(!id) return;
      await set(ref(db, `${ns}/aktuelleId`), id);
    };

    // Neuen Wettbewerb anlegen
    el("neuBtn").onclick = async ()=>{
      const neueId = String(Math.floor(Math.random()*1e6)).padStart(5,"0");
      const basis = {
        phasen: {
          einwurfStart: new Date(Date.now()+60*60*1000).toISOString(),
          abstimmStart: new Date(Date.now()+48*60*60*1000).toISOString(),
          gewinnerStart: new Date(Date.now()+72*60*60*1000).toISOString(),
          ende: new Date(Date.now()+96*60*60*1000).toISOString()
        },
        bilder: {},
        gewinner: {}
      };
      await set(ref(db, `${ns}/wettbewerbe/${neueId}`), basis);
      await set(ref(db, `${ns}/aktuelleId`), neueId);
    };

    // Wettbewerb löschen
    el("delBtn").onclick = async ()=>{
      const id = el("aktSel").value || aktuelleId;
      if(!id) return;
      if(!confirm(`Wettbewerb ${id} wirklich löschen?`)) return;
      await remove(ref(db, `${ns}/wettbewerbe/${id}`));
      const cur = await get(ref(db, `${ns}/aktuelleId`));
      if(cur.exists() && cur.val()===id) await set(ref(db, `${ns}/aktuelleId`), null);
    };

    // Zähler öffentlich
    el("toggleZaehler").onchange = async (e)=>{
      await set(ref(db, `${ns}/einstellungen/zeigeZaehler`), !!e.target.checked);
    };

    // Alles rendern (Phasen, Bilder, Stimmen, Gewinner)
    function renderAlles(){
      const id = aktuelleId;
      const w = id ? alleWettbewerbe[id] : null;

      // Phasen
      if(!w){
        ["einwurf","abstimm","gewinner","ende"].forEach(k=> el(k).value="");
      }else{
        el("einwurf").value  = toLocalValue(w.phasen?.einwurfStart);
        el("abstimm").value  = toLocalValue(w.phasen?.abstimmStart);
        el("gewinner").value = toLocalValue(w.phasen?.gewinnerStart);
        el("ende").value     = toLocalValue(w.phasen?.ende);
      }
      // Bilderliste
      renderBilder();
      // Stimmenübersicht
      renderStimmenUebersicht();
      // Gewinner
      renderGewinner();
    }

    // Phasen speichern
    el("savePhasen").onclick = async ()=>{
      if(!aktuelleId) return;
      const upd = {
        [`${ns}/wettbewerbe/${aktuelleId}/phasen/einwurfStart`]: fromLocalValue(el("einwurf").value),
        [`${ns}/wettbewerbe/${aktuelleId}/phasen/abstimmStart`]: fromLocalValue(el("abstimm").value),
        [`${ns}/wettbewerbe/${aktuelleId}/phasen/gewinnerStart`]: fromLocalValue(el("gewinner").value),
        [`${ns}/wettbewerbe/${aktuelleId}/phasen/ende`]: fromLocalValue(el("ende").value)
      };
      await update(ref(db), upd);
    };

    // Bilder rendern + hinzufügen/entfernen
    function renderBilder(){
      const box = el("bilderList"); box.innerHTML="";
      const w = alleWettbewerbe[aktuelleId] || { bilder:{} };
      const bilder = w.bilder || {};
      Object.keys(bilder).forEach(bid=>{
        const row = document.createElement("div");
        row.className="item";
        row.innerHTML = `
          <img class="thumb" src="${bilder[bid].url}" alt="">
          <div class="spacer">
            <div class="muted">${bilder[bid].url}</div>
          </div>
          <button class="secondary danger" data-del="${bid}">Löschen</button>`;
        box.appendChild(row);
      });
      box.querySelectorAll("[data-del]").forEach(btn=>{
        btn.onclick = async ()=>{
          const bid = btn.dataset.del;
          await remove(ref(db, `${ns}/wettbewerbe/${aktuelleId}/bilder/${bid}`));
          // zugehörige Stimmen optional behalten; hier nicht löschen
        };
      });
    }

    el("addBildBtn").onclick = async ()=>{
      if(!aktuelleId) return;
      const url = el("bildUrl").value.trim();
      if(!url) return;
      const id = push(ref(db, "tmp")).key; // generate id
      await set(ref(db, `${ns}/wettbewerbe/${aktuelleId}/bilder/${id}`), { url });
      el("bildUrl").value="";
    };

    // Stimmen-Übersicht: Thumbnails + Counts + Overlay mit Wählerliste
    async function renderStimmenUebersicht(){
      const box = el("votesList"); box.innerHTML="";
      if(!aktuelleId) return;
      const w = alleWettbewerbe[aktuelleId] || {};
      const bilder = w.bilder || {};

      const sSnap = await get(ref(db, `${ns}/stimmen/${aktuelleId}`));
      const stimmen = sSnap.exists()? sSnap.val() : {};
      // pro Bild Id sammeln
      const per = {}; // {bildId:{count,names:[]}}
      Object.keys(stimmen).forEach(k=>{
        const v = stimmen[k]; // {bildId, zeit}
        if(!v || !v.bildId) return;
        if(!per[v.bildId]) per[v.bildId] = { count:0, names:[] };
        per[v.bildId].count++;
        per[v.bildId].names.push(decodeKey(k));
      });

      // Reihenfolge: nach Count absteigend, sonst Einfüge
      const ids = Object.keys(bilder);
      ids.sort((a,b)=>(per[b]?.count||0)-(per[a]?.count||0));

      ids.forEach(bid=>{
        const row = document.createElement("div");
        row.className="item";
        const c = per[bid]?.count || 0;
        row.innerHTML = `
          <img class="thumb" src="${bilder[bid].url}" alt="">
          <div class="spacer">
            <div><strong>Bild-ID:</strong> <span class="muted">${bid}</span></div>
          </div>
          <span class="badge">${c} Stimme${c===1?"":"n"}</span>
          <button class="secondary" data-show="${bid}">Wähler anzeigen</button>
        `;
        box.appendChild(row);
      });

      box.querySelectorAll("[data-show]").forEach(btn=>{
        btn.onclick = ()=>{
          const bid = btn.dataset.show;
          const names = (per[bid]?.names || []).sort((a,b)=>{
            const ta=a.startsWith("~"), tb=b.startsWith("~");
            if(ta!==tb) return ta?1:-1;
            return a.localeCompare(b,'de',{sensitivity:'base'});
          });
          // Modal füllen
          document.querySelector("#voteModal img").src = (alleWettbewerbe[aktuelleId].bilder[bid]?.url)||"";
          el("voteList").innerHTML = names.length? names.map(n=>`<span class="chip">${n}</span>`).join("") : `<span class="muted">Noch keine Stimmen.</span>`;
          el("voteModal").style.display="flex";
        };
      });
    }

    // Gewinner rendern + speichern
    function renderGewinner(){
      const w = alleWettbewerbe[aktuelleId] || { bilder:{}, gewinner:{} };
      const bilder = w.bilder || {};
      const ids = Object.keys(bilder);

      ["g1","g2","g3"].forEach((sid,i)=>{
        const sel = el(sid); sel.innerHTML="";
        const o0 = document.createElement("option"); o0.value=""; o0.textContent="— auswählen —"; sel.appendChild(o0);
        ids.forEach(id=>{
          const o = document.createElement("option"); o.value=id; o.textContent=id;
          sel.appendChild(o);
        });
      });

      if(w.gewinner){
        el("g1").value = w.gewinner.platz1 || "";
        el("g2").value = w.gewinner.platz2 || "";
        el("g3").value = w.gewinner.platz3 || "";
      }

      const prev = el("gewinnerPreview"); prev.innerHTML="";
      ["platz1","platz2","platz3"].forEach((k,idx)=>{
        const id = w.gewinner?.[k];
        if(id && bilder[id]){
          const row = document.createElement("div");
          row.className="item";
          row.innerHTML = `<img class="thumb" src="${bilder[id].url}"><div><strong>Platz ${idx+1}</strong><div class="muted">${id}</div></div>`;
          prev.appendChild(row);
        }
      });
    }

    el("saveGewinner").onclick = async ()=>{
      if(!aktuelleId) return;
      const data = {
        platz1: el("g1").value || null,
        platz2: el("g2").value || null,
        platz3: el("g3").value || null
      };
      await set(ref(db, `${ns}/wettbewerbe/${aktuelleId}/gewinner`), data);
      renderGewinner();
    };

    // Modal schließen
    window.closeModal=()=>{ el("voteModal").style.display="none"; };
  </script>
</head>
<body>
  <h1>Malwettbewerb – Admin</h1>

  <div class="section">
    <h2>Aktueller Wettbewerb</h2>
    <div class="row">
      <select id="aktSel"></select>
      <button id="setAktivBtn">Setzen</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="neuBtn" class="secondary">Neuen Wettbewerb anlegen</button>
      <button id="delBtn" class="danger">Wettbewerb löschen</button>
    </div>
  </div>

  <div class="grid-2">
    <div class="section">
      <h2>Phasen</h2>
      <div class="row"><span class="muted">Einwurfphase start</span></div>
      <input id="einwurf" type="datetime-local">
      <div class="row" style="margin-top:8px"><span class="muted">Abstimmphase start</span></div>
      <input id="abstimm" type="datetime-local">
      <div class="row" style="margin-top:8px"><span class="muted">Gewinnerphase start</span></div>
      <input id="gewinner" type="datetime-local">
      <div class="row" style="margin-top:8px"><span class="muted">Ende</span></div>
      <input id="ende" type="datetime-local">
      <div class="row" style="margin-top:10px"><button id="savePhasen">Speichern</button></div>
    </div>

    <div class="section">
      <h2>Bilder</h2>
      <div class="row">
        <input id="bildUrl" type="text" placeholder="https://…">
        <button id="addBildBtn" class="secondary">Hinzufügen</button>
      </div>
      <div id="bilderList" class="list"></div>
    </div>
  </div>

  <div class="section">
    <h2>Stimmen (Übersicht)</h2>
    <label class="toggle">
      <input id="toggleZaehler" type="checkbox" />
      <span>Zähler öffentlich zeigen (Kinderansicht) – standard AUS</span>
    </label>
    <div id="votesList" class="list" style="margin-top:10px"></div>
  </div>

  <div class="section">
    <h2>Gewinner auswählen</h2>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <div><div class="muted">Platz 1</div><select id="g1" style="min-width:200px"></select></div>
      <div><div class="muted">Platz 2</div><select id="g2" style="min-width:200px"></select></div>
      <div><div class="muted">Platz 3</div><select id="g3" style="min-width:200px"></select></div>
      <div class="spacer"></div>
      <button id="saveGewinner">Speichern</button>
    </div>
    <div id="gewinnerPreview" class="list" style="margin-top:10px"></div>
  </div>

  <!-- Modal: Wählerliste zu einem Bild -->
  <div id="voteModal" class="overlay">
    <div class="dialog">
      <div class="row" style="align-items:center;gap:12px">
        <img src="" alt="" style="width:56px;height:56px;border-radius:10px;object-fit:cover;background:#f2f2f2">
        <h3 style="margin:0">Stimmen – Details</h3>
        <div class="spacer"></div>
        <button class="secondary" onclick="closeModal()">Schließen</button>
      </div>
      <div id="voteList" class="chips" style="margin-top:12px"></div>
    </div>
  </div>
</body>
</html>
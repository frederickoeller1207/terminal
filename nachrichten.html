<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MausBriefkasten</title>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--brand1:#7aa8ff;--brand2:#6ee7b7;--ink:#1b1b1f;--card:#fff;--muted:#666}
  *{box-sizing:border-box}
  body{font-family:'SF Pro Display',sans-serif;margin:0;background:linear-gradient(135deg,var(--brand1),#ff7ab6);min-height:100vh;color:var(--ink)}
  .wrap{max-width:900px;margin:0 auto;padding:28px 16px 40px}
  header{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:18px;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.15)}
  header h1{margin:0;font-size:32px}
  .mail{width:40px;height:40px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
  .card{background:var(--card);border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.15);padding:18px}
  p.lead{font-size:18px;line-height:1.5;margin:0 0 14px}
  .btn{appearance:none;border:0;border-radius:12px;padding:14px 18px;font-weight:800;font-size:18px;cursor:pointer;color:#fff;background:#111;box-shadow:0 6px 18px rgba(0,0,0,.18)}
  .btn:active{transform:translateY(1px)}
  .muted{color:var(--muted)}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .dialog{background:#fff;border-radius:16px;max-width:520px;width:calc(100% - 32px);padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  label{font-weight:700}
  input,select,textarea{font-family:inherit;font-size:16px;border:1px solid #e5e7eb;border-radius:10px;padding:12px}
  textarea{min-height:140px;resize:vertical}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:6px}
  /* Toast */
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111;color:#fff;padding:12px 16px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:80}
  .toast.show{opacity:1}
</style>
<script type="module">
  import { initializeApp as initApp1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB1, ref as ref1, get as get1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
  import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB2, ref as ref2, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  // Apps: gesamt (Codes) + punkte (Konten + Briefkasten)
  const appGesamt = initApp1({
    apiKey:"AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
    databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app"
  },"gesamtApp");
  const dbGesamt = getDB1(appGesamt);

  const appPunkte = initApp2({
    apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
    databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
  },"punkteApp");
  const dbPunkte = getDB2(appPunkte);

  const $ = (q)=>document.querySelector(q);

  const accounts = new Map(); // name -> {punkte, type}
  onValue(ref2(dbPunkte,"kinder"), s => mergeAccounts(s,"kinder"));
  onValue(ref2(dbPunkte,"auslandskonten"), s => mergeAccounts(s,"auslandskonten"));

  function mergeAccounts(snap,type){
    const val = snap.exists()? snap.val(): {};
    Object.keys(val).forEach(n=>accounts.set(n,{ punkte: val[n]?.punkte ?? 0, type }));
  }

  function sortedNames(){
    return Array.from(accounts.keys()).sort((a,b)=>{
      const at=a.startsWith("~"), bt=b.startsWith("~");
      if(at!==bt) return at?1:-1;
      const na=at?a.slice(1):a, nb=bt?b.slice(1):b;
      return na.localeCompare(nb,'de',{sensitivity:'base'});
    });
  }

  function toast(msg){
    const t = $("#toast"); t.textContent=msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  }

  // Modal öffnen
  window.openCompose = ()=>{
    $("#compose").style.display="flex";
    // Namen füllen
    const sel = $("#nameSel"); sel.innerHTML="";
    sortedNames().forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; sel.appendChild(o); });
    $("#pin").value="";
    $("#topic").value="Wünsche";
    $("#topicCustomWrap").style.display="none";
    $("#topicCustom").value="";
    $("#msg").value="";
  };

  // Thema: Eigenes Thema → Eingabefeld zeigen
  window.onTopicChange = ()=>{
    const v = $("#topic").value;
    $("#topicCustomWrap").style.display = (v==="__custom__") ? "block" : "none";
  };

  // Senden
  window.sendMsg = async ()=>{
    const name = $("#nameSel").value;
    const pinEntered = ($("#pin").value||"").trim();
    const topic = $("#topic").value;
    const own = ($("#topicCustom").value||"").trim();
    const text = ($("#msg").value||"").trim();

    if(!name || !pinEntered){ toast("Bitte Name und PIN eingeben."); return; }
    if(topic==="__custom__" && !own){ toast("Bitte eigenes Thema eingeben."); return; }
    if(!text){ toast("Bitte eine Nachricht schreiben."); return; }

    // PIN prüfen (aus gesamt/kinder/{name}/code)
    const codeSnap = await get1(ref1(dbGesamt, `kinder/${name}/code`));
    const correct = codeSnap.exists()? (codeSnap.val()||"") : "";
    if(!correct){ toast("Kein PIN hinterlegt."); return; }
    if(pinEntered !== correct){ toast("Falscher PIN."); return; }

    // Nachricht speichern
    const now = new Date().toISOString();
    const data = {
      absender: name,
      userType: accounts.get(name)?.type || "kinder",
      thema: topic==="__custom__" ? own : topic,
      text,
      zeit: now
    };
    const ref = push(ref2(dbPunkte, "briefkasten/nachrichten"));
    await set(ref, data);

    $("#compose").style.display="none";
    toast("Nachricht eingeworfen.");
  };

  // Modal schließen
  window.closeCompose = ()=>{ $("#compose").style.display="none"; };
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <svg class="mail" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M3 6h18v12H3z" stroke="#fff" stroke-width="2" />
        <path d="M3 7l9 7 9-7" stroke="#fff" stroke-width="2" />
      </svg>
      <h1>MausBriefkasten</h1>
    </header>

    <div class="card">
      <p class="lead">
        Hier kannst du etwas in den <b>digitalen Briefkasten</b> einwerfen und eine Nachricht an
        <b>Herr Köller</b> und <b>Frau Stanojevic</b> schreiben.
      </p>
      <button class="btn" onclick="openCompose()">Neue Nachricht</button>
      <p class="muted" style="margin-top:10px">Unbegrenzt Nachrichten möglich.</p>
    </div>
  </div>

  <!-- Compose Modal -->
  <div id="compose" class="modal">
    <div class="dialog">
      <h2 style="margin:0 0 8px">Neue Nachricht</h2>
      <div class="grid">
        <div class="row2">
          <div>
            <label for="nameSel">Absender</label>
            <select id="nameSel"></select>
          </div>
          <div>
            <label for="pin">PIN</label>
            <input id="pin" type="tel" inputmode="numeric" placeholder="Sicherheitscode">
          </div>
        </div>

        <div>
          <label for="topic">Thema</label>
          <select id="topic" onchange="onTopicChange()">
            <option>Wünsche</option>
            <option>Beschwerden oder Sorgen</option>
            <option>Fragen</option>
            <option>Ideen</option>
            <option>Quiz Vorschläge</option>
            <option value="__custom__">Eigenes Thema …</option>
          </select>
        </div>

        <div id="topicCustomWrap" style="display:none">
          <label for="topicCustom">Eigenes Thema</label>
          <input id="topicCustom" type="text" placeholder="Thema eingeben">
        </div>

        <div>
          <label for="msg">Nachricht</label>
          <textarea id="msg" placeholder="Schreibe deine Nachricht …"></textarea>
        </div>

        <div class="btnRow">
          <button class="btn" onclick="sendMsg()">Absenden</button>
          <button class="btn" style="background:#e5e7eb;color:#111" onclick="closeCompose()">Schließen</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Hinweis</div>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>M√§usegruppe ‚Äì Nachrichten</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:'SF Pro Display',sans-serif;background:#f9f9fb;color:#1c1c1e;margin:0;padding:16px}
  h1{font-size:24px;text-align:center;margin:0 0 16px}
  .menu, .view{display:flex;flex-direction:column;align-items:center;gap:12px}
  button{background:#fff;border:1px solid #ccc;border-radius:12px;padding:14px 18px;font-size:18px;font-weight:600;cursor:pointer;width:95%;max-width:360px}
  input, textarea, select{width:95%;max-width:360px;font-size:16px;padding:10px;border:1px solid #ccc;border-radius:10px}
  .row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
  .chat{width:95%;max-width:700px;background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
  .msg{margin:6px 0;padding:8px 10px;border-radius:10px;border:1px solid #eee}
  .me{background:#e6f7ff}
  .other{background:#f3f4f6}
  .topbar{display:flex;justify-content:space-between;align-items:center;width:95%;max-width:700px;margin:6px auto}
  .pill{font-size:12px;border:1px solid #ddd;border-radius:999px;padding:4px 8px;background:#fff}
  .threads{width:95%;max-width:700px;display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
  .threadBtn{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fff;cursor:pointer}
  #home{color:#007aff;cursor:pointer;margin:8px auto;text-align:center}
</style>
</head>
<body>
<h1>Nachrichten</h1>
<div id="home">üè† Zur√ºck</div>
<div id="view" class="view"></div>

<script type="module">
  import { initializeApp as init1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB1, ref as ref1, get as get1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
  import { initializeApp as init2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB2, ref as ref2, onValue, get, set, push, update } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  // app1: Codes, app2: Konten + Chats
  const app1 = init1({ apiKey:"AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU", databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app" },"a1");
  const db1  = getDB1(app1);
  const app2 = init2({ apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg", databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app" },"a2");
  const db2  = getDB2(app2);

  const view = document.getElementById("view");
  const home = document.getElementById("home");
  home.onclick = ()=>{ window.location.href = "index.html"; };

  let ALL_KIDS = []; // nur Konten mit farbe
  let currentKid = null; // eingeloggt
  let currentPeer = null;

  function convId(a,b){ return [a,b].sort((x,y)=>x.localeCompare(y,'de')).join("|"); }
  function top(text){ const h=document.createElement("div");h.className="topbar";
    const left=document.createElement("div");left.textContent=text;
    const right=document.createElement("div");
    const btn=document.createElement("button"); btn.textContent="Nachricht senden"; btn.onclick=openCompose;
    right.appendChild(btn); h.appendChild(left); h.appendChild(right); return h; }

  // Schritt 1: Kinder w√§hlen
  async function loadKids(){
    const s = await get(ref2(db2,"kinder"));
    ALL_KIDS.length=0;
    if (s.exists()){
      s.forEach(ch=>{ const v=ch.val()||{}; if (v.farbe!==undefined) ALL_KIDS.push(ch.key); });
      ALL_KIDS.sort((a,b)=>a.localeCompare(b,'de'));
    }
    renderLogin();
  }

  function renderLogin(){
    view.innerHTML="";
    const info = document.createElement("div"); info.textContent="W√§hle deinen Namen:";
    view.appendChild(info);
    ALL_KIDS.forEach(name=>{
      const b=document.createElement("button"); b.textContent=name;
      b.onclick=()=>askPinAndLogin(name);
      view.appendChild(b);
    });
  }

  async function askPinAndLogin(name){
    const snap = await get1(ref1(db1,`kinder/${name}`));
    if (!snap.exists() || !snap.val().code){ alert("Kein PIN hinterlegt."); return; }
    const code = String(snap.val().code);
    view.innerHTML="";
    const inp=document.createElement("input"); inp.type="number"; inp.placeholder=`PIN f√ºr ${name}`;
    const ok=document.createElement("button"); ok.textContent="OK";
    ok.onclick=()=>{ if (String(inp.value)===code){ currentKid=name; openInbox(); } else alert("Falscher PIN."); };
    view.appendChild(inp); view.appendChild(ok); inp.focus();
  }

  // Inbox + Threads
  function openInbox(){
    view.innerHTML="";
    view.appendChild(top(`Angemeldet: ${currentKid}`));

    // Threads: wer hat mir geschrieben?
    const threadsWrap = document.createElement("div"); threadsWrap.className="threads";
    view.appendChild(threadsWrap);

    onValue(ref2(db2, `threadsByKid/${currentKid}`), (snap)=>{
      threadsWrap.innerHTML="";
      const peers = [];
      if (snap.exists()) snap.forEach(ch=>peers.push(ch.key));
      // zuletzt aktive zuerst: sortiere nach letzter Nachricht in conv
      Promise.all(peers.map(async p=>{
        const lastTs = await getLastTs(currentKid,p);
        return {p,lastTs};
      })).then(rows=>{
        rows.sort((a,b)=>(b.lastTs||0)-(a.lastTs||0));
        rows.forEach(({p})=>{
          const t=document.createElement("button"); t.className="threadBtn"; t.textContent=p;
          t.onclick=()=>openChat(p);
          threadsWrap.appendChild(t);
        });
      });
    });

    // Compose-Shortcut
    const pick = document.createElement("select");
    pick.innerHTML = `<option value="">Empf√§nger w√§hlen‚Ä¶</option>` + ALL_KIDS.filter(n=>n!==currentKid).map(n=>`<option>${n}</option>`).join("");
    const txt  = document.createElement("textarea"); txt.rows=2; txt.placeholder="Nachricht‚Ä¶";
    const send = document.createElement("button"); send.textContent="Senden";
    send.onclick = ()=>{ if(!pick.value || !txt.value.trim()) return; sendMsg(currentKid, pick.value, txt.value.trim(), "kid"); txt.value=""; };
    view.appendChild(pick); view.appendChild(txt); view.appendChild(send);
  }
  function openCompose(){ // Toolbar-Button
    if (!currentKid) return;
    const pick = document.createElement("select");
    pick.style.marginTop="8px";
    pick.innerHTML = `<option value="">Empf√§nger w√§hlen‚Ä¶</option>` + ALL_KIDS.filter(n=>n!==currentKid).map(n=>`<option>${n}</option>`).join("");
    const txt  = document.createElement("textarea"); txt.rows=3; txt.placeholder="Deine Nachricht‚Ä¶";
    const send = document.createElement("button"); send.textContent="Senden";
    send.onclick = ()=>{ if(!pick.value || !txt.value.trim()) return; sendMsg(currentKid, pick.value, txt.value.trim(), "kid"); txt.remove(); send.remove(); pick.remove(); };
    view.insertBefore(send, view.children[1]);
    view.insertBefore(txt,  view.children[1]);
    view.insertBefore(pick, view.children[1]);
  }

  async function getLastTs(a,b){
    const s = await get(ref2(db2,`chats/${convId(a,b)}`));
    let t=0; if (s.exists()) s.forEach(ch=>{ const v=ch.val()||{}; t=Math.max(t, v.ts||0); });
    return t;
  }

  function openChat(peer){
    currentPeer = peer;
    // Kopf
    const header = top(`Chat: ${peer}`);
    // Chatverlauf
    const box=document.createElement("div"); box.className="chat"; box.id="chatBox";
    // Eingabe
    const row=document.createElement("div"); row.className="row";
    const inp=document.createElement("input"); inp.placeholder="Nachricht‚Ä¶";
    const send=document.createElement("button"); send.textContent="Senden";
    send.onclick=()=>{ const t=inp.value.trim(); if(!t) return; sendMsg(currentKid, peer, t, "kid"); inp.value=""; };
    row.appendChild(inp); row.appendChild(send);

    // Render
    view.innerHTML=""; view.appendChild(header); view.appendChild(box); view.appendChild(row);

    // Live-Feed
    onValue(ref2(db2,`chats/${convId(currentKid,peer)}`),(snap)=>{
      box.innerHTML="";
      const msgs=[];
      if (snap.exists()) snap.forEach(ch=>msgs.push(ch.val()));
      msgs.sort((a,b)=>(a.ts||0)-(b.ts||0));
      msgs.forEach(m=>{
        const d=document.createElement("div"); d.className="msg "+(m.from===currentKid?"me":"other");
        const who = m.fromType==="admin" ? (m.from || "Admin") : m.from;
        d.innerHTML=`<div class="pill">${who}</div><div>${m.text}</div>`;
        box.appendChild(d);
      });
      box.scrollTop=box.scrollHeight;
    });
  }

  async function sendMsg(from, to, text, fromType){
    const cid = convId(from,to);
    const mRef = push(ref2(db2,`chats/${cid}`));
    const msg = { from, to, text, ts: Date.now(), fromType };
    await set(mRef, msg);
    // Threads-Index aktualisieren
    await Promise.all([
      update(ref2(db2,`threadsByKid/${from}`), { [to]: true }),
      update(ref2(db2,`threadsByKid/${to}`),   { [from]: true })
    ]);
    // wenn Chat offen ist, neu laden √ºbernimmt onValue
  }

  loadKids();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mäusegruppe – Nachrichten</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family:'SF Pro Display',sans-serif; margin:0; background:#ece5dd; }
  .header { background:#075e54; color:#fff; padding:14px; font-weight:600; display:flex; align-items:center; }
  .header button { background:none; border:none; color:#fff; font-size:20px; margin-right:10px; cursor:pointer; }
  .list { padding:10px; }
  .list button { display:block; width:100%; text-align:left; padding:14px; margin-bottom:8px;
                 background:#fff; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
  .chat-window { display:none; flex-direction:column; height:100vh; }
  .messages { flex:1; overflow-y:auto; padding:10px; background:#ece5dd; }
  .msg { max-width:70%; margin:6px 0; padding:10px 14px; border-radius:16px; font-size:15px; position:relative; }
  .me { align-self:flex-end; background:#dcf8c6; border-bottom-right-radius:0; }
  .other { align-self:flex-start; background:#fff; border-bottom-left-radius:0; }
  .msg small { display:block; font-size:11px; color:#555; margin-top:4px; text-align:right; }
  .composer { display:flex; padding:8px; background:#f0f0f0; }
  .composer input { flex:1; border:1px solid #ccc; border-radius:20px; padding:8px 12px; font-size:15px; }
  .composer button { margin-left:8px; background:#075e54; border:none; color:#fff; padding:8px 16px; border-radius:20px; font-weight:600; cursor:pointer; }
  .new-chat { padding:14px; text-align:center; background:#fff; border-top:1px solid #eee; cursor:pointer; font-weight:600; color:#075e54; }
</style>
</head>
<body>

<!-- Auswahl Name -->
<div id="loginView">
  <div class="header">Wähle deinen Namen</div>
  <div id="nameList" class="list"></div>
</div>

<!-- Chatliste -->
<div id="chatListView" style="display:none">
  <div class="header">Nachrichten</div>
  <div id="chatList" class="list"></div>
  <div class="new-chat" onclick="openNewChat()">➕ Neue Nachricht</div>
</div>

<!-- Chatfenster -->
<div id="chatWindow" class="chat-window">
  <div class="header">
    <button onclick="backToList()">←</button>
    <div id="chatTitle"></div>
  </div>
  <div id="messages" class="messages"></div>
  <div class="composer">
    <input id="msgInput" placeholder="Nachricht eingeben...">
    <button onclick="sendCurrent()">Senden</button>
  </div>
</div>

<script type="module">
  import { initializeApp as init1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB1, ref as ref1, get as get1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
  import { initializeApp as init2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB2, ref as ref2, onValue, get, set, push, update } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  // app1: Codes, app2: Chats
  const app1 = init1({ apiKey:"AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU", databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app" },"a1");
  const db1 = getDB1(app1);
  const app2 = init2({ apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg", databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app" },"a2");
  const db2 = getDB2(app2);

  let ALL_KIDS = [];
  let currentKid=null, currentPeer=null;

  function convId(a,b){ return [a,b].sort((x,y)=>x.localeCompare(y,'de')).join("|"); }

  // Kinderliste laden
  async function loadKids(){
    const s=await get(ref2(db2,"kinder"));
    if(s.exists()){ s.forEach(ch=>ALL_KIDS.push(ch.key)); }
    renderLogin();
  }

  function renderLogin(){
    const list=document.getElementById("nameList");
    list.innerHTML="";
    ALL_KIDS.sort().forEach(name=>{
      const b=document.createElement("button");
      b.textContent=name;
      b.onclick=()=>askPin(name);
      list.appendChild(b);
    });
  }

  async function askPin(name){
    const snap=await get1(ref1(db1,`kinder/${name}`));
    if(!snap.exists()||!snap.val().code){ alert("Kein PIN"); return; }
    const pin=prompt(`PIN für ${name} eingeben:`);
    if(pin===String(snap.val().code)){
      currentKid=name;
      document.getElementById("loginView").style.display="none";
      document.getElementById("chatListView").style.display="block";
      loadThreads();
    } else { alert("Falscher PIN."); }
  }

  function loadThreads(){
    const chatList=document.getElementById("chatList");
    onValue(ref2(db2,`threadsByKid/${currentKid}`),(snap)=>{
      chatList.innerHTML="";
      if(!snap.exists()){ chatList.innerHTML="<div>Keine Chats</div>"; return; }
      Object.keys(snap.val()).forEach(peer=>{
        const item=document.createElement("button"); item.textContent=peer;
        item.onclick=()=>openChat(peer);
        chatList.appendChild(item);
      });
    });
  }

  function openChat(peer){
    currentPeer=peer;
    document.getElementById("chatListView").style.display="none";
    document.getElementById("chatWindow").style.display="flex";
    document.getElementById("chatTitle").textContent=peer;
    const box=document.getElementById("messages");
    onValue(ref2(db2,`chats/${convId(currentKid,peer)}`),(snap)=>{
      box.innerHTML="";
      const msgs=[]; if(snap.exists()) snap.forEach(ch=>msgs.push(ch.val()));
      msgs.sort((a,b)=>(a.ts||0)-(b.ts||0));
      msgs.forEach(m=>{
        const d=document.createElement("div"); d.className="msg "+(m.from===currentKid?"me":"other");
        d.innerHTML=`${m.text}<small>${new Date(m.ts).toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})}</small>`;
        box.appendChild(d);
      });
      box.scrollTop=box.scrollHeight;
    });
  }

  function backToList(){
    document.getElementById("chatWindow").style.display="none";
    document.getElementById("chatListView").style.display="block";
  }

  async function sendMsg(from,to,text){
    const cid=convId(from,to);
    const ref=push(ref2(db2,`chats/${cid}`));
    await set(ref,{from,to,text,ts:Date.now(),fromType:"kid"});
    await update(ref2(db2,`threadsByKid/${from}`),{[to]:true});
    await update(ref2(db2,`threadsByKid/${to}`),{[from]:true});
  }

  function sendCurrent(){
    const inp=document.getElementById("msgInput");
    const t=inp.value.trim(); if(!t) return;
    sendMsg(currentKid,currentPeer,t);
    inp.value="";
  }

  function openNewChat(){
    const peer=prompt("An wen?");
    if(!ALL_KIDS.includes(peer)||peer===currentKid){ alert("Ungültig"); return; }
    openChat(peer);
  }

  loadKids();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malwettbewerb</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fafafa; text-align:center; }
    h1 { font-size:28px; margin:20px; color:#333; }
    #notice { margin:20px; font-size:20px; color:#444; }
    #gallery { display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px; padding:20px; }
    .img-card { background:#fff; border-radius:8px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15); transition:transform .2s; }
    .img-card:hover { transform:scale(1.02); cursor:pointer; }
    .img-card img { width:100%; height:auto; border-radius:6px; }
    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:1000; }
    .overlay.hidden { display:none; }
    .overlay-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; text-align:center; }
    select, input { width:90%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:6px; font-size:16px; }
    button { background:#007bff; color:#fff; border:none; border-radius:6px; padding:12px 20px; font-size:16px; margin-top:10px; cursor:pointer; }
    button:hover { background:#0056b3; }
    #loading { font-size:22px; margin:50px; color:#666; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Malwettbewerb</h1>
  <div id="loading">Bilder werden geladen. Bitte warte ...</div>
  <div id="notice"></div>
  <div id="gallery"></div>

  <!-- Abstimmen Overlay -->
  <div id="voteOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Für dieses Bild abstimmen?</h2>
      <select id="kindSel"></select>
      <input type="tel" id="codeInput" placeholder="Sicherheitscode">
      <button id="sendVote">Stimme versenden</button>
      <p id="voteError" style="color:red;"></p>
      <button onclick="closeOverlay()">Schließen</button>
    </div>
  </div>

<script>
const configPunkte = {
  apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
  databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
};
const configGesamt = {
  apiKey: "AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
  databaseURL: "https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app"
};
const appPunkte = firebase.initializeApp(configPunkte,"punkte");
const appGesamt = firebase.initializeApp(configGesamt,"gesamt");
const dbPunkte = appPunkte.database();
const dbGesamt = appGesamt.database();

const ns="malwettbewerb";
let aktuelleId=null;
let bilder={};
let accountsMap={};
let selectedBild=null;

// helper sort
function getSortedAccountNames(){
  return Object.keys(accountsMap).sort((a,b)=>{
    const aTilde=a.startsWith("~"), bTilde=b.startsWith("~");
    if(aTilde!==bTilde) return aTilde?1:-1;
    const na=aTilde?a.slice(1):a;
    const nb=bTilde?b.slice(1):b;
    return na.localeCompare(nb,'de',{sensitivity:'base'});
  });
}

// phase anzeigen
function renderNotice(t){document.getElementById("notice").innerText=t;}
function renderGallery(){
  const g=document.getElementById("gallery"); g.innerHTML="";
  Object.keys(bilder).forEach(id=>{
    const card=document.createElement("div"); card.className="img-card";
    const im=document.createElement("img"); im.src=bilder[id].url; 
    im.onclick=()=>openVoteFlow(id);
    card.appendChild(im); g.appendChild(card);
  });
}

function checkPhase(phasen){
  const now=new Date();
  const einwurf=new Date(phasen.einwurfStart||0);
  const abstimm=new Date(phasen.abstimmStart||0);
  const gewinner=new Date(phasen.gewinnerStart||0);
  const ende=new Date(phasen.ende||0);

  if(!phasen.einwurfStart){ renderNotice("Momentan ist kein aktiver Malwettbewerb."); return "none"; }

  if(now>=einwurf && now<abstimm){
    const diffMs=abstimm-now;
    const diffDays=Math.max(1,Math.ceil(diffMs/(1000*60*60*24)));
    if(diffDays===1){
      renderNotice("Momentan werden die Malwettbewerb-Bilder ausgewertet. Bitte komme in einem Tag zurück und stimme für dein Lieblingsbild ab.");
    }else{
      renderNotice(`Momentan wird für den Malwettbewerb gesammelt. Du hast noch ${diffDays} Tage dein Bild in den Briefkasten vor der Tür einzuwerfen. Komme in ${diffDays} Tagen wieder zurück und stimme für dein Lieblingsbild ab.`);
    }
    return "einwurf";
  }
  if(now>=abstimm && now<gewinner){ renderNotice("Stimme jetzt für dein Lieblingsbild ab."); renderGallery(); return "abstimm"; }
  if(now>=gewinner && now<ende){ renderNotice("Die Gewinnerbilder stehen fest."); return "gewinner"; }
  renderNotice("Momentan ist kein aktiver Malwettbewerb."); return "none";
}

function openVoteFlow(bildId){
  selectedBild=bildId;
  const sel=document.getElementById("kindSel"); sel.innerHTML="";
  getSortedAccountNames().forEach(name=>{
    const o=document.createElement("option");
    o.value=name; o.textContent=name;
    sel.appendChild(o);
  });
  document.getElementById("codeInput").value="";
  document.getElementById("voteError").innerText="";
  document.getElementById("voteOverlay").classList.remove("hidden");
}
function closeOverlay(){document.getElementById("voteOverlay").classList.add("hidden");}

document.getElementById("sendVote").onclick=()=>{
  const name=document.getElementById("kindSel").value;
  const entered=document.getElementById("codeInput").value.trim();
  dbGesamt.ref(`kinder/${name}/code`).once("value", snap=>{
    if(!snap.exists()||snap.val()!==entered){ document.getElementById("voteError").innerText="Falscher Code."; return; }
    dbPunkte.ref(`${ns}/stimmen/${aktuelleId}/${name}`).once("value", s2=>{
      if(s2.exists()){ document.getElementById("voteError").innerText="Du hast bereits für diesen Malwettbewerb abgestimmt."; return; }
      dbPunkte.ref(`${ns}/stimmen/${aktuelleId}/${name}`).set({bildId:selectedBild,zeit:new Date().toISOString()});
      closeOverlay(); alert("Deine Stimme wurde gespeichert.");
    });
  });
};

// lade accounts
function loadAccounts(){
  dbGesamt.ref("kinder").once("value").then(s=>{
    accountsMap=s.val()||{};
  });
}

// lade aktuelle Daten
dbPunkte.ref(`${ns}/aktuelleId`).on("value", snap=>{
  aktuelleId=snap.val();
  if(!aktuelleId){ document.getElementById("loading").style.display="none"; renderNotice("Momentan ist kein aktiver Malwettbewerb."); return; }
  dbPunkte.ref(`${ns}/wettbewerbe/${aktuelleId}`).on("value", s=>{
    const data=s.val()||{};
    bilder=data.bilder||{};
    document.getElementById("loading").style.display="none";
    checkPhase(data.phasen||{});
  });
});

loadAccounts();
</script>
</body>
</html>
<!DOCTYPE html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Malwettbewerb</title>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--brand1:#ff7ab6;--brand2:#7aa8ff;--brand3:#6ee7b7;--ink:#1b1b1f;--card:#ffffff;--muted:#61666b}
  body{font-family:'SF Pro Display',sans-serif;background:linear-gradient(135deg,var(--brand2)10%,var(--brand1)90%) fixed;margin:0;min-height:100vh;color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:28px 16px 40px}
  header{display:flex;gap:14px;align-items:center;justify-content:center;margin-bottom:18px}
  header h1{font-size:34px;margin:0;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.15)}
  .brush{width:38px;height:38px;flex:0 0 auto;filter:drop-shadow(0 2px 6px rgba(0,0,0,.2))}
  .card{background:var(--card);border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.15);padding:18px}
  .notice{font-size:20px;line-height:1.55}
  .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
  @media(min-width:700px){.grid{grid-template-columns:1fr 1fr}}
  @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr 1fr}}
  .tile{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.12)}
  .tile img{display:block;width:100%;height:auto;object-fit:contain;background:#f7f7f9}
  .badge{display:inline-block;margin:8px 10px;background:linear-gradient(90deg,var(--brand3),var(--brand2));color:#053;font-weight:800;border-radius:999px;padding:6px 10px;font-size:14px}
  .btn{display:inline-block;background:#111;color:#fff;border:0;border-radius:12px;padding:14px 18px;font-weight:800;font-size:18px;cursor:pointer}
  .btn.alt{background:#eef2ff;color:#111}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
  .dialog{background:#fff;border-radius:16px;max-width:480px;width:calc(100% - 32px);padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.3)}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  label{font-weight:800}
  input,select{font-family:inherit;font-size:18px;border:1px solid #e1e1e6;border-radius:12px;padding:12px}
  .loading{position:fixed;inset:0;background:rgba(255,255,255,.92);display:none;align-items:center;justify-content:center;z-index:50}
  .loaderCard{background:#fff;border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.2);padding:18px 20px;text-align:center;max-width:520px}
  .muted{color:var(--muted)}
</style>
<script type="module">
  import { initializeApp as initApp1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB1, ref as ref1, get as get1, onValue as onVal1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
  import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase as getDB2, ref as ref2, get as get2, onValue as onVal2, set as set2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  /* gesamt -> Codes */
  const app1 = initApp1({
    apiKey:"AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
    databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app"
  },"app1");
  const db1 = getDB1(app1);

  /* punkte -> Konten + Malwettbewerb */
  const app2 = initApp2({
    apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
    databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
  },"app2");
  const db2 = getDB2(app2);

  const ns = "malwettbewerb";
  const $ = (q)=>document.querySelector(q);

  let aktuelleId = "";
  let bilderMap = {};
  let zeigeZaehler = false;

  // Kontoquelle wie im Shop: punkte/kinder + punkte/auslandskonten, Codeprüfung gegen gesamt/kinder
  let accountsMap = {}; // name -> {punkte, type}

  window.addEventListener("DOMContentLoaded", init);

  async function init(){
    try{
      const ez = await get2(ref2(db2, `${ns}/einstellungen/zeigeZaehler`));
      zeigeZaehler = !!(ez.exists()? ez.val(): false);
    }catch{}

    // Accounts live laden (beide Pfade wie im Shop)
    onVal2(ref2(db2, `kinder`), snap => mergeAccounts(snap, "kinder"));
    onVal2(ref2(db2, `auslandskonten`), snap => mergeAccounts(snap, "auslandskonten"));

    const cur = await get2(ref2(db2, `${ns}/aktuelleId`));
    aktuelleId = cur.exists()? cur.val() : "";
    if(!aktuelleId){ renderNotice("Momentan ist kein aktiver Malwettbewerb."); return; }

    const wSnap = await get2(ref2(db2, `${ns}/wettbewerbe/${aktuelleId}`));
    const w = wSnap.val()||{};
    const ph = w.phasen||{};
    const now = new Date();
    const einwurf  = ph.einwurfStart?  new Date(ph.einwurfStart):null;
    const abstimm  = ph.abstimmStart?  new Date(ph.abstimmStart):null;
    const gewinner = ph.gewinnerStart? new Date(ph.gewinnerStart):null;
    const ende     = ph.ende?          new Date(ph.ende):null;

    if(!einwurf||!abstimm||!gewinner||!ende || now<einwurf){
      renderNotice("Momentan ist kein aktiver Malwettbewerb."); return;
    }

    const lockStart = new Date(abstimm.getTime() - 24*60*60*1000);

    if(now>=einwurf && now<lockStart){
      const daysToLock = daysCeil(lockStart - now);
      const daysToVote = daysCeil(abstimm - now);
      renderNotice(`Momentan wird für den Malwettbewerb gesammelt. Du hast noch <b>${daysToLock} ${daysToLock===1?"Tag":"Tage"}</b>, dein Bild in den Briefkasten vor der Tür einzuwerfen. Komme in <b>${daysToVote} ${daysToVote===1?"Tag":"Tagen"}</b> wieder zurück und stimme für dein Lieblingsbild ab.`);
      return;
    }

    if(now>=lockStart && now<abstimm){
      renderNotice(`Momentan werden die Malwettbewerb-Bilder ausgewertet. Bitte komme in <b>1 Tag</b> zurück.`);
      return;
    }

    if(now>=abstimm && now<gewinner){
      const bilder = (w.bilder||{});
      const ids = Object.keys(bilder);
      if(ids.length===0){ renderNotice("Es sind noch keine Bilder vorhanden."); return; }

      showLoading("Bilder werden geladen. Bitte warte …");
      try{
        await Promise.race([preloadAll(ids.map(id=>bilder[id].url)), new Promise((_,rej)=>setTimeout(()=>rej("timeout"),10000))]);
      }catch{}
      hideLoading();
      bilderMap = bilder;
      renderVoting(ids);
      return;
    }

    if(now>=gewinner && now<ende){ renderWinners(w); return; }

    renderNotice("Der Malwettbewerb ist beendet.");
  }

  function mergeAccounts(snap, type){
    const val = snap.exists()? snap.val() : {};
    // zusammenführen
    Object.keys(val).forEach(name=>{
      accountsMap[name] = { punkte: val[name]?.punkte ?? 0, type };
    });
  }

  function daysCeil(ms){ return Math.max(1, Math.ceil(ms/(1000*60*60*24))); }

  function renderNotice(html){
    $("header").innerHTML = `
      <svg class="brush" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="g2" x1="50" y1="6" x2="14" y2="58"><stop stop-color="#6ee7b7"/><stop offset=".5" stop-color="#ff7ab6"/><stop offset="1" stop-color="#7aa8ff"/></linearGradient></defs>
        <path d="M50 6c4 0 8 4 8 8 0 3-2 6-4 8L24 52c-2 2-5 3-8 3-6 0-10-5-10-11 0-3 1-6 3-8L42 10c2-2 5-4 8-4Z" fill="url(#g2)"/>
      </svg>
      <h1>Malwettbewerb</h1>`;
    $(".content").innerHTML = `<div class="card"><div class="notice">${html}</div></div>`;
  }

  function showLoading(txt){
    const l=$("#loading");
    l.innerHTML = `<div class="loaderCard"><strong>${txt}</strong><div class="muted" style="margin-top:6px">Die Seite wird sichtbar, sobald alles geladen ist.</div></div>`;
    l.style.display="flex";
  }
  function hideLoading(){ $("#loading").style.display="none"; }

  async function preloadAll(urls){
    await Promise.all(urls.map(u=>new Promise((res,rej)=>{
      const img = new Image();
      img.onload=()=>res(); img.onerror=rej;
      img.decoding="async"; img.loading="eager"; img.src=u;
    })));
  }

  function renderVoting(ids){
    $(".content").innerHTML = "";
    const headCard = document.createElement("div");
    headCard.className="card";
    headCard.innerHTML = `<div class="notice" style="font-size:22px">Abstimmphase: Wähle genau ein Lieblingsbild.</div>`;
    $(".content").appendChild(headCard);

    const grid = document.createElement("div");
    grid.className="grid";
    ids.forEach(id=>{
      const url = bilderMap[id].url;
      const tile = document.createElement("div");
      tile.className="tile";
      const img = document.createElement("img");
      img.src=url; img.alt="Bild"; img.loading="lazy"; img.decoding="async";
      img.onclick = ()=>openVoteFlow(id,url);
      tile.appendChild(img);
      if(zeigeZaehler){
        const b = document.createElement("div");
        b.className="badge"; b.dataset.bid=id; b.textContent="—";
        tile.appendChild(b);
      }
      grid.appendChild(tile);
    });
    $(".content").appendChild(grid);

    if(zeigeZaehler){
      onVal2(ref2(db2, `${ns}/stimmen/${aktuelleId}`), s=>{
        const votes = s.val()||{};
        const per = {};
        Object.values(votes).forEach(v=>{ per[v.bildId]=(per[v.bildId]||0)+1; });
        document.querySelectorAll('[data-bid]').forEach(el=>{
          const id = el.dataset.bid; el.textContent = `${per[id]||0} Stimme(n)`;
        });
      });
    }
  }

  function renderWinners(w){
    const g = w.gewinner||{};
    const ids = [g.platz1,g.platz2,g.platz3].filter(Boolean);
    if(ids.length===0){ $(".content").innerHTML = `<div class="card"><div class="notice">Die Gewinner werden vorbereitet.</div></div>`; return; }
    const grid = document.createElement("div"); grid.className="grid";
    ids.forEach((id,idx)=>{
      const url = (w.bilder||{})[id]?.url; if(!url) return;
      const tile = document.createElement("div");
      tile.className="tile";
      tile.innerHTML = `<img src="${url}" alt="Gewinner"><div class="card" style="border-radius:0 0 16px 16px"><strong>Platz ${idx+1}</strong></div>`;
      grid.appendChild(tile);
    });
    $(".content").innerHTML = ""; $(".content").appendChild(grid);
  }

  function openVoteFlow(bildId, url){
    const m = $("#modal"); m.style.display="flex";
    $("#vprev").src=url;
    $("#confirmText").textContent = "Möchtest du für dieses Bild abstimmen? Du kannst nur einmal abstimmen.";

    // Dropdown aus punkte/kinder + punkte/auslandskonten (wie Shop)
    const sel = $("#kindSel"); sel.innerHTML="";
    Object.keys(accountsMap).sort((a,b)=>a.localeCompare(b)).forEach(name=>{
      const o=document.createElement("option"); o.value=name; o.textContent=name; sel.appendChild(o);
    });

    $("#code").value="";
    $("#sendBtn").onclick = () => sendVote(bildId);
  }

  async function sendVote(bildId){
    const name = $("#kindSel").value;
    if(!name) return;

    // einmalige Stimme pro Wettbewerb
    if(await hasVoted(name)){
      alert("Du hast bereits für diesen Malwettbewerb abgestimmt. Du kannst beim nächsten Mal wieder abstimmen.");
      closeModal(); return;
    }

    // Codeprüfung wie Shop: gesamt/kinder/{name}/code
    const entered = $("#code").value.trim();
    const codeSnap = await get1(ref1(db1, `kinder/${name}/code`));
    const stored = codeSnap.exists()? (codeSnap.val()||"") : "";
    if(!stored){ alert("Kein Sicherheitscode hinterlegt."); return; }
    if(entered !== stored){ alert("Falscher Code."); return; }

    // race-sichere Zweitprüfung
    if(await hasVoted(name)){
      alert("Du hast bereits für diesen Malwettbewerb abgestimmt. Du kannst beim nächsten Mal wieder abstimmen.");
      closeModal(); return;
    }

    await set2(ref2(db2, `${ns}/stimmen/${aktuelleId}/${encodeKey(name)}`), {
      bildId, zeit: new Date().toISOString()
    });
    alert("Stimme versendet. Danke.");
    closeModal();
  }

  async function hasVoted(kind){
    const s = await get2(ref2(db2, `${ns}/stimmen/${aktuelleId}/${encodeKey(kind)}`));
    return s.exists();
  }

  function encodeKey(name){ return name.replaceAll("/","_"); }
  function closeModal(){ $("#modal").style.display="none"; }
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <svg class="brush" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs><linearGradient id="g2" x1="50" y1="6" x2="14" y2="58"><stop stop-color="#6ee7b7"/><stop offset=".5" stop-color="#ff7ab6"/><stop offset="1" stop-color="#7aa8ff"/></linearGradient></defs>
        <path d="M50 6c4 0 8 4 8 8 0 3-2 6-4 8L24 52c-2 2-5 3-8 3-6 0-10-5-10-11 0-3 1-6 3-8L42 10c2-2 5-4 8-4Z" fill="url(#g2)"/>
      </svg>
      <h1>Malwettbewerb</h1>
    </header>
    <div class="content">
      <div class="card"><div class="notice">Lade…</div></div>
    </div>
  </div>

  <!-- Modal Abstimmen -->
  <div id="modal" class="modal">
    <div class="dialog">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <img id="vprev" src="" alt="Bild" style="width:120px;height:auto;object-fit:contain;border-radius:10px;border:1px solid #eee;background:#f7f7f9">
        <div id="confirmText" style="font-weight:800;font-size:20px">Möchtest du für dieses Bild abstimmen?</div>
      </div>
      <div class="row" style="margin-top:8px">
        <label for="kindSel">Mit welchem Konto möchtest du abstimmen?</label>
        <select id="kindSel"></select>
        <input id="code" type="number" inputmode="numeric" placeholder="Sicherheitscode">
        <button id="sendBtn" class="btn">Stimme versenden</button>
        <button class="btn alt" onclick="document.querySelector('#modal').style.display='none'">Schließen</button>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loading" class="loading"><div class="loaderCard">Lade…</div></div>
</body></html>
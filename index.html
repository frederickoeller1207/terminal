<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>M√§usegruppe Terminal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f2f4f8; --ink:#1c1c1e; --muted:#6b7280; --card:#ffffff;
      --ring:#e5e7eb; --brand:#007aff; --shadow:0 10px 25px rgba(0,0,0,.08);
      --accent:#22c55e; --accent2:#f59e0b
    }
    *{box-sizing:border-box}
    body{font-family:'SF Pro Display',sans-serif;background:linear-gradient(135deg,#e6f0ff 0%,#fef3f7 100%);min-height:100vh;margin:0;color:var(--ink);display:flex;flex-direction:column}
    h1{margin:20px 0 10px;font-size:28px;font-weight:700;text-align:center}

    /* App grid */
    .app-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;max-width:780px;width:100%;padding:0 16px 24px;margin:8px auto 24px}
    @media(min-width:700px){.app-grid{grid-template-columns:repeat(4,1fr)}}
    .app{background:var(--card);border:1px solid var(--ring);border-radius:18px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:transform .08s ease, box-shadow .2s}
    .app:active{transform:translateY(1px)}
    .app:hover{box-shadow:0 14px 32px rgba(0,0,0,.1)}
    .app img{width:86px;height:86px;object-fit:contain;border-radius:16px}
    .app .title{font-weight:700;font-size:16px;text-align:center}
    .app .sub{font-size:12px;color:var(--muted);text-align:center}

    /* View */
    #home-btn{display:none;justify-content:center;font-size:16px;color:var(--brand);cursor:pointer;margin-bottom:10px}
    #view{display:flex;flex-direction:column;align-items:center;gap:16px;padding:0 16px 32px}

    /* Cards & base controls */
    .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow);padding:16px;width:100%;max-width:780px}
    .mt-center{margin-top:8vh}       /* hilft, Karten mittiger zu positionieren */
    .section-title{font-weight:700;margin:6px 0 2px}
    .muted{color:var(--muted)}

    input, select, textarea{width:100%;max-width:520px;font-size:16px;padding:12px 14px;border:1px solid var(--ring);border-radius:12px;background:#fff}
    .btn{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:14px 18px;font-size:18px;font-weight:600;color:#000;box-shadow:0 2px 5px rgba(0,0,0,.05);cursor:pointer;width:100%;max-width:520px;text-align:center;transition:all .2s, transform .1s}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:#fff;border-style:dashed}

    /* Vertikale Namensliste (Buttons untereinander) */
    .name-list{display:flex;flex-direction:column;gap:10px;width:100%;max-width:520px;margin-top:8px}
    .name-list .btn{padding:16px 18px;font-size:18px}

    /* Konto einsehen ‚Äì gr√∂√üere Typo */
    .details-grid{display:grid;grid-template-columns:1fr;gap:14px}
    .stat{background:#f9fafb;border:1px solid var(--ring);border-radius:14px;padding:16px}
    .stat .label{font-size:16px;color:var(--muted);letter-spacing:.2px}
    .stat .value{font-size:26px;font-weight:800;margin-top:8px}
    .color-circle{width:30px;height:30px;border-radius:50%;border:1px solid #d1d5db;display:inline-block;vertical-align:middle;margin-right:10px}

    /* Betrag-Grid: 2 Spalten, gro√üe Buttons */
    .grid-amount{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%;max-width:520px;margin-top:10px}
    .amount-btn{padding:18px;border:1px solid var(--ring);border-radius:14px;background:#fff;font-weight:800;font-size:22px;cursor:pointer;text-align:center}
    .amount-btn.custom{grid-column:1/-1;font-size:18px;font-weight:700}

    /* Gr√ºnde */
    .grid-reason{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:100%;max-width:520px}
    .reason-btn{padding:14px;border:1px solid var(--ring);border-radius:12px;background:#fff;font-weight:600;cursor:pointer;text-align:center}
    
    /* Hidden legacy menu */
    .legacy-menu{display:none}
  </style>
</head>
<body>
  <h1 id="title">M√§usegruppe Terminal</h1>

  <!-- App-Startseite -->
  <div class="app-grid" id="app-grid">
    <div class="app" onclick="showKontoEinsehen()">
      <img src="https://i.supaimg.com/0483c192-7c11-41e0-92c1-e980e9b50f60.png" alt="Konto">
      <div class="title">Konto einsehen</div>
      <div class="sub">Kontostand & Farbe</div>
    </div>
    <div class="app" onclick="window.location.href='https://frederickoeller1207.github.io/ziele/'">
      <img src="https://i.supaimg.com/5abf1dba-fcbb-472c-a9bc-3c15894c1bcb.png" alt="Ziel">
      <div class="title">Mein Ziel</div>
      <div class="sub">Fortschritt ansehen</div>
    </div>
    <div class="app" onclick="openAusleihe()">
      <img src="https://i.supaimg.com/dea106e1-18eb-4ae7-b2ea-ca3ded6e63c1.png" alt="Ausleihe">
      <div class="title">Spielzeug ausleihen</div>
      <div class="sub">mit PIN</div>
    </div>
    <div class="app" onclick="openCheckout()">
      <img src="https://i.supaimg.com/652a2719-c338-4a37-a712-7dd6d56945b5.png" alt="Checkout">
      <div class="title">Checkout</div>
      <div class="sub">mit PIN</div>
    </div>
    <div class="app" onclick="openMausdollar()">
      <img src="https://i.supaimg.com/d256e5e6-05bd-43b0-a548-6c10c1e43efe.png" alt="Mausdollar">
      <div class="title">Mausdollar hinzuf√ºgen</div>
      <div class="sub">Anfrage senden</div>
    </div>
    <div class="app" onclick="window.location.href='https://frederickoeller1207.github.io/Mousecity-Store/'">
      <img src="https://i.supaimg.com/1fc31392-99ae-4970-8cee-474e784ef93f.png" alt="Store">
      <div class="title">Mousecity Store</div>
      <div class="sub">Einkaufen</div>
    </div>
    <div class="app" onclick="window.location.href='malwettbewerb.html'">
      <img src="https://i.supaimg.com/359b3d2b-2cc2-48dd-86b2-4f44ee584857.png" alt="Malwettbewerb">
      <div class="title">Malwettbewerb</div>
      <div class="sub">Abgeben & abstimmen</div>
    </div>
    <div class="app" onclick="window.location.href='nachrichten.html'">
      <img src="https://i.supaimg.com/965bbc7f-a8a5-43f8-a7d1-90ce44c21053.png" alt="Briefkasten">
      <div class="title">MausBriefkasten</div>
      <div class="sub">Nachricht schreiben</div>
    </div>
  </div>

  <!-- Legacy Men√º (unsichtbar, Handler bleiben) -->
  <div id="menu" class="legacy-menu">
    <button id="btn-kontoeinsehen">Konto einsehen</button>
    <button onclick="window.location.href='https://frederickoeller1207.github.io/ziele/'">Mein Ziel</button>
    <button id="btn-ausleihe">Spielzeug Ausleihe</button>
    <button id="btn-checkout">Checkout</button>
    <button id="btn-mausdollar">Mausdollar hinzuf√ºgen</button>
    <button onclick="window.location.href='https://frederickoeller1207.github.io/Mousecity-Store/'">Mousecity Store</button>
  </div>

  <div id="home-btn">üè† Zur√ºck</div>
  <div id="view"></div>

  <script type="module">
    import { initializeApp as initApp1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB1, ref as ref1, get as get1, onValue as onVal1, set as set1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase as getDB2, ref as ref2, get as get2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const config1 = {
      apiKey: "AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
      authDomain: "gesamt-dae4e.firebaseapp.com",
      databaseURL: "https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gesamt-dae4e",
      storageBucket: "gesamt-dae4e.appspot.com",
      messagingSenderId: "844023612743",
      appId: "1:844023612743:web:0821aa894541f89a7df862"
    };
    const config2 = {
      apiKey: "AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
      authDomain: "punkte-45c20.firebaseapp.com",
      databaseURL: "https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "punkte-45c20",
      storageBucket: "punkte-45c20.appspot.com",
      messagingSenderId: "931713539549",
      appId: "1:931713539549:web:e348bf38369639f1906a34"
    };

    const app1 = initApp1(config1, "app1"); const db1 = getDB1(app1);
    const app2 = initApp2(config2, "app2"); const db2 = getDB2(app2);

    const view = document.getElementById("view");
    const homeBtn = document.getElementById("home-btn");

    const resetView = () => { view.innerHTML=""; homeBtn.style.display="none"; document.getElementById("title").textContent="M√§usegruppe Terminal"; document.getElementById('app-grid').style.display='grid'; };
    const openView = (title) => { view.innerHTML=""; homeBtn.style.display="flex"; document.getElementById("title").textContent=title; document.getElementById('app-grid').style.display='none'; };
    homeBtn.onclick = resetView;

    function eingabeMitZahl(title, callback, placeholder="Zahl eingeben"){
      openView(title);
      const card=document.createElement("div"); card.className="card mt-center";
      card.innerHTML = `
        <div class="section-title">${title}</div>
        <input type="number" inputmode="numeric" id="num-inp" placeholder="${placeholder}">
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn primary" id="ok-btn">OK</button>
          <button class="btn ghost" id="cancel-btn">Abbrechen</button>
        </div>`;
      view.appendChild(card);
      const input = card.querySelector("#num-inp"); input.focus();
      card.querySelector("#ok-btn").onclick = ()=>{ const val=input.value.trim(); if(val) callback(val); };
      card.querySelector("#cancel-btn").onclick = resetView;
    }

    async function checkSicherheitscode(name, callback){
      const snap = await get1(ref1(db1, `kinder/${name}`));
      const code = snap.exists()? snap.val().code : null;
      if(!code){ alert("Kein Sicherheitscode hinterlegt."); return; }
      eingabeMitZahl(`Bitte Sicherheitscode f√ºr ${name} eingeben:`, (eingabe)=>{
        if(eingabe===code) callback(); else alert("Falscher Code.");
      }, "PIN");
    }

    /* Hilfs-Sortierung: Alphabetisch, ~ ans Ende */
    function sortNamesWithTildeLast(arr){
      return arr.sort((a,b)=>{
        const at=a.startsWith("~"), bt=b.startsWith("~");
        if(at!==bt) return at?1:-1;
        const aa=at?a.slice(1):a, bb=bt?b.slice(1):b;
        return aa.localeCompare(bb,'de',{sensitivity:'base'});
      });
    }

    /* ===== Konto einsehen ===== */
    document.getElementById("btn-kontoeinsehen").onclick = showKontoEinsehen;
    function farbeToColor(f){ if(f==="üî¥")return"red"; if(f==="üü°")return"orange"; if(f==="üü¢")return"green"; if(f==="‚ö´")return"black"; if(f==="üü£")return"purple"; if(f==="üîµ")return"blue"; return"#e5e7eb";}
    function getFarbBedeutung(f){
      if(f==="üü¢")return"Du bist deinem Ziel heute 5 % n√§her.";
      if(f==="üü£")return"Du bist deinem Ziel heute 10 % n√§her.";
      if(f==="üî¥")return"Du entfernst dich heute um 5 % von deinem Ziel.";
      if(f==="‚ö´")return"Du entfernst dich heute um 10 % von deinem Ziel.";
      if(f==="üü°"||f==="‚ö™")return"Dein Ziel-Fortschritt bleibt heute unver√§ndert.";
      return"";
    }
    async function showKontoEinsehen(){
      openView("Konto einsehen");
      // Namensliste (untereinander)
      const choose=document.createElement("div"); choose.className="card mt-center";
      choose.innerHTML = `<div class="section-title">W√§hle ein Konto</div>`;
      const list=document.createElement("div"); list.className="name-list"; choose.appendChild(list);
      view.appendChild(choose);

      const snap=await get2(ref2(db2,"kinder"));
      const names=[];
      if(snap.exists()){ snap.forEach(s=>names.push(s.key)); }
      sortNamesWithTildeLast(names).forEach(n=>{
        const b=document.createElement("button"); b.className="btn"; b.textContent=n;
        b.onclick=async ()=>{
          const kSnap = await get2(ref2(db2,`kinder/${n}`));
          const konto = {name:n, ...(kSnap.val()||{})};
          showKontoDetails(konto);
        };
        list.appendChild(b);
      });
    }
    window.showKontoEinsehen = showKontoEinsehen;

    function showKontoDetails(konto){
      openView(konto.name);
      const card=document.createElement("div"); card.className="card mt-center";
      const grid=document.createElement("div"); grid.className="details-grid";

      const kontostand=Number(konto.punkte??konto.kontostand??0);
      const stat1=document.createElement("div"); stat1.className="stat";
      stat1.innerHTML=`<div class="label">Kontostand</div><div class="value">${kontostand} M$</div>`;
      grid.appendChild(stat1);

      const stat2=document.createElement("div"); stat2.className="stat";
      let farbeHtml = konto.farbe
        ? `<span class="color-circle" style="background:${farbeToColor(konto.farbe)}"></span>${konto.farbe}`
        : `<span class="muted">keine Farbe</span>`;
      stat2.innerHTML=`<div class="label">Heutige Farbe</div><div class="value" style="display:flex;align-items:center;gap:10px">${farbeHtml}</div>`;
      grid.appendChild(stat2);

      const info=document.createElement("div"); info.className="stat"; info.style.gridColumn="1/-1";
      info.innerHTML=`<div class="label">Bedeutung</div><div style="margin-top:6px;font-size:18px">${konto.farbe?getFarbBedeutung(konto.farbe):"Dein Ziel-Fortschritt bleibt heute unver√§ndert."}</div>`;

      card.appendChild(grid); card.appendChild(info);
      view.appendChild(card);
    }

    /* ===== Ausleihe ===== */
    document.getElementById("btn-ausleihe").onclick = () => { openAusleihe(); };
    window.openAusleihe = () => {
      openView("Spielzeug Ausleihe");
      onVal1(ref1(db1,"kinder"), snapshot => {
        const card=document.createElement("div"); card.className="card mt-center";
        card.innerHTML=`<div class="section-title">W√§hle deinen Namen</div>`;
        const list=document.createElement("div"); list.className="name-list"; card.appendChild(list);
        const names=[]; snapshot.forEach(s=>names.push(s.key));
        sortNamesWithTildeLast(names).forEach(name=>{
          const b=document.createElement("button"); b.className="btn"; b.textContent=name;
          b.onclick=()=>checkSicherheitscode(name,()=>ausleihen(name));
          list.appendChild(b);
        });
        view.innerHTML=""; view.appendChild(card);
      });
    };
    function frageSpielzeugnummer(name,cb){ eingabeMitZahl(`${name}, gib bitte die Spielzeugnummer ein:`, cb, "z.B. 102"); }
    async function ausleihen(name){
      const ausleiheSnap=await get1(ref1(db1,`ausleihen/${name}`));
      if(ausleiheSnap.exists() && ausleiheSnap.val().best√§tigt===false){ alert("Bitte gib das ausgeliehene Spielzeug zur√ºck."); return; }
      frageSpielzeugnummer(name, async (nummer)=>{
        const spielzeugeSnap=await get1(ref1(db1,"spielzeuge")); const spielzeuge=spielzeugeSnap.exists()? spielzeugeSnap.val():{};
        if(spielzeuge[nummer]){
          await set1(ref1(db1,`ausleihen/${name}`),{spielzeug:spielzeuge[nummer],nummer,zeit:new Date().toISOString(),best√§tigt:false});
          const card=document.createElement("div"); card.className="card mt-center";
          card.innerHTML=`<div class="section-title">Ausleihe erfolgreich</div><div class="muted">‚Äû${spielzeuge[nummer]}‚Äú wurde f√ºr dich reserviert.</div>`;
          view.innerHTML=""; view.appendChild(card);
          setTimeout(resetView,1600);
        } else { alert("Ung√ºltige Nummer."); }
      });
    }

    /* ===== Checkout ===== */
    document.getElementById("btn-checkout").onclick = () => { openCheckout(); };
    window.openCheckout = () => {
      openView("Checkout");
      onVal1(ref1(db1,"kinder"), snapshot => {
        const card=document.createElement("div"); card.className="card mt-center";
        card.innerHTML=`<div class="section-title">W√§hle deinen Namen</div>`;
        const list=document.createElement("div"); list.className="name-list"; card.appendChild(list);
        const items=[]; snapshot.forEach(s=>items.push({name:s.key, link:s.val().link}));
        sortNamesWithTildeLast(items.map(i=>i.name)).forEach(n=>{
          const link = items.find(i=>i.name===n)?.link;
          const b=document.createElement("button"); b.className="btn"; b.textContent=n;
          b.onclick=()=>checkSicherheitscode(n,()=>{ if(link) window.location.href=link; else alert("Kein Link hinterlegt."); });
          list.appendChild(b);
        });
        view.innerHTML=""; view.appendChild(card);
      });
    };

    /* ===== Mausdollar hinzuf√ºgen (2 Spalten gro√ü, mittig) ===== */
    document.getElementById("btn-mausdollar").onclick = () => { openMausdollar(); };
    window.openMausdollar = () => {
      openView("Mausdollar hinzuf√ºgen");
      const choose=document.createElement("div"); choose.className="card mt-center";
      choose.innerHTML = `<div class="section-title">W√§hle ein Konto</div>`;
      const list=document.createElement("div"); list.className="name-list"; choose.appendChild(list);
      view.appendChild(choose);

      const names=[];
      onVal1(ref1(db1,"kinder"), snapshot=>{
        list.innerHTML=""; names.length=0; snapshot.forEach(s=>names.push(s.key));
        sortNamesWithTildeLast(names).forEach(name=>{
          const b=document.createElement("button"); b.className="btn"; b.textContent=name;
          b.onclick=()=>checkSicherheitscode(name,()=>waehleBetrag(name));
          list.appendChild(b);
        });
      });
    };

    function waehleBetrag(name){
      openView(`${name}: Betrag w√§hlen`);
      const card=document.createElement("div"); card.className="card mt-center";
      card.innerHTML = `<div class="section-title">Wie viele Mausdollar?</div><div class="muted">Du kannst einen Vorschlag antippen oder einen eigenen Betrag eingeben.</div>`;
      const grid=document.createElement("div"); grid.className="grid-amount"; card.appendChild(grid);

      const order=[1,2,3,4,5,6];
      order.forEach(n=>{
        const b=document.createElement("button"); b.className="amount-btn"; b.textContent=n;
        b.onclick=()=>waehleGrund(name,n);
        grid.appendChild(b);
      });

      const custom=document.createElement("button"); custom.className="amount-btn custom"; custom.textContent="Eigener Betrag";
      custom.onclick=()=>eingabeMitZahl("Eigener Betrag", (val)=>{
        const n = Math.max(1, Math.floor(Number(val)||0));
        waehleGrund(name,n);
      },"z.B. 7");
      grid.appendChild(custom);

      view.appendChild(card);
    }

    function waehleGrund(name,betrag){
      openView(`${name}: Grund w√§hlen`);
      const card=document.createElement("div"); card.className="card mt-center";
      card.innerHTML=`<div class="section-title">Wof√ºr bekommst du Mausdollar?</div>`;
      const grid=document.createElement("div"); grid.className="grid-reason"; card.appendChild(grid);

      const gruende=["Quiz","Kurze Hilfe","Malwettbewerb","Tischdienst","Aufr√§umen","Besondere Tat"];
      gruende.forEach(g=>{
        const b=document.createElement("button"); b.className="reason-btn"; b.textContent=g;
        b.onclick=()=>sendeAnfrage(name,betrag,g);
        grid.appendChild(b);
      });

      const own=document.createElement("div"); own.style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center";
      own.innerHTML=`<input id="own-reason" type="text" placeholder="Eigener Grund" style="flex:1;min-width:0"><button class="btn primary" id="send-own">Absenden (${betrag} M$)</button>`;
      card.appendChild(own);
      view.appendChild(card);

      card.querySelector("#send-own").onclick = ()=>{
        const g = card.querySelector("#own-reason").value.trim();
        if(g) sendeAnfrage(name,betrag,g);
      };
    }

    function sendeAnfrage(name,betrag,grund){
      const now=new Date();
      const tag=String(now.getDate()).padStart(2,'0');
      const monat=String(now.getMonth()+1).padStart(2,'0');
      const stunde=String(now.getHours()).padStart(2,'0');
      const minute=String(now.getMinutes()).padStart(2,'0');
      const zeit=`${tag}.${monat} ‚Äì ${stunde}:${minute}`;
      const anfrageRef=ref1(db1,`anfragen/${Date.now()}_${name}`);
      set1(anfrageRef,{name,betrag,grund,zeit});
      const card=document.createElement("div"); card.className="card mt-center";
      card.innerHTML=`<div class="section-title">Anfrage gesendet ‚úÖ</div><div class="muted">${betrag} Mausdollar f√ºr: <b>${grund}</b></div>`;
      view.innerHTML=""; view.appendChild(card);
      setTimeout(resetView,1400);
    }

    /* Start */
    resetView();
  </script>
</body>
</html>
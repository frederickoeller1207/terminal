<!DOCTYPE html>
<html lang="de">
<head>
Â  <meta charset="UTF-8" />
Â  <title>MÃ¤usegruppe Terminal</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
Â  <style>
Â  Â  :root{--bg:#f2f4f8;--ink:#1c1c1e;--muted:#6b7280;--card:#ffffff;--ring:#e5e7eb;--brand:#007aff;--shadow:0 10px 25px rgba(0,0,0,.08)}
Â  Â  *,*::before,*::after{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{font-family:'SF Pro Display',sans-serif;background:linear-gradient(135deg,#e6f0ff 0%,#fef3f7 100%);min-height:100vh;margin:0;color:var(--ink);display:flex;flex-direction:column;overflow-x:hidden}
Â  Â  .page{width:100%;max-width:420px;margin:0 auto;padding:12px}
Â  Â  h1{margin:12px 0 8px;font-size:24px;font-weight:700;text-align:center}
Â  Â  #home-btn{display:none;justify-content:center;font-size:16px;color:var(--brand);cursor:pointer;margin:6px 0 10px}
Â  Â  #notices{width:100%;margin:6px 0 10px;display:none}
Â  Â  .notice{border-radius:12px;padding:10px 12px;margin:8px 0;box-shadow:var(--shadow);color:#fff}
Â  Â  .notice h3{margin:0 0 4px 0;font-size:14px;font-weight:700;opacity:.95}
Â  Â  .notice p{margin:0;font-size:13px;line-height:1.35;white-space:pre-wrap}
Â  Â  .n-blue{background:#1e40af}.n-red{background:#b91c1c}.n-green{background:#047857}
Â  Â  .n-orange{background:#c2410c}.n-purple{background:#6d28d9}.n-black{background:#111827}.n-gray{background:#374151}

Â  Â  .mode-banner{display:none;border:1px dashed #f59e0b;background:#fff8e1;color:#7a4d00;border-radius:10px;padding:10px 12px;font-weight:700;margin:8px 0}
Â  Â  .locked-banner{display:none;border:1px solid #ef4444;background:#ffecec;color:#7a0000;border-radius:10px;padding:10px 12px;font-weight:800;margin:8px 0;text-align:center}

Â  Â  .app-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;width:100%;margin:8px 0 16px}
Â  Â  .app{background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:var(--shadow);padding:10px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;transition:transform .08s ease,box-shadow .2s;min-height:118px}
Â  Â  .app:active{transform:translateY(1px)} .app:hover{box-shadow:0 14px 32px rgba(0,0,0,.1)}
Â  Â  .app img{width:60px;height:60px;object-fit:contain;border-radius:12px}
Â  Â  .app .title{font-weight:700;font-size:14px;text-align:center}
Â  Â  .app .sub{font-size:11px;color:var(--muted);text-align:center}

Â  Â  .legacy-menu{display:none}
Â  Â  #view{display:flex;flex-direction:column;align-items:center;gap:12px}
Â  Â  input{width:95%;max-width:340px;font-size:16px;padding:12px;margin-top:12px;border:1px solid #ccc;border-radius:10px}
Â  Â  button{background:#fff;border:1px solid #ccc;border-radius:10px;padding:14px 18px;font-size:16px;font-weight:600;color:#000;box-shadow:0 2px 5px rgba(0,0,0,.05);cursor:pointer;width:95%;max-width:340px;text-align:center;transition:all .2s,transform .1s}
Â  Â  button:hover{background:#f0f0f5} button:active{background:#e0e0e5;transform:scale(.98)}
Â  Â  #konto-details{display:flex;flex-direction:column;align-items:center;gap:10px;font-size:16px;text-align:center}
Â  Â  .color-circle{width:22px;height:22px;border-radius:50%;border:1px solid #ccc;margin-top:4px}

Â  Â  .amount-wrap{width:100%;max-width:520px;display:flex;flex-direction:column;align-items:center;margin-top:6px;padding-bottom:8px}
Â  Â  .amount-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;width:100%}
Â  Â  .amount-btn{padding:14px 0;font-size:20px;font-weight:800;border:1px solid #ccc;border-radius:12px;background:#fff}
Â  Â  .amount-btn.custom{grid-column:1/-1;font-size:16px}

Â  Â  #lock-overlay{display:none;position:fixed;inset:0;pointer-events:none;z-index:99998}
Â  Â  #lock-overlay::before{content:"";position:absolute;left:50%;top:50%;width:140vmax;height:8px;background:#ef4444;transform:translate(-50%,-50%) rotate(-45deg);box-shadow:0 0 0 2px #ef4444}
Â  Â  #toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.25);font-size:14px;display:none;z-index:99999;max-width:90%;text-align:center}
Â  Â Â 
Â  Â  /* Sperr-Pop-up Struktur */
Â  Â  .lock-popup-overlay {
Â  Â  Â  position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none;
Â  Â  Â  justify-content: center; align-items: center; z-index: 99999;
Â  Â  }
Â  Â  .lock-popup-content {
Â  Â  Â  background: var(--card); border-radius: 12px; padding: 20px;
Â  Â  Â  box-shadow: var(--shadow); width: 90%; max-width: 350px; text-align: center;
Â  Â  }
Â  Â  .lock-popup-title {
Â  Â  Â  font-size: 18px; font-weight: 700; color: #fff; background: #ef4444;
Â  Â  Â  border-radius: 8px; padding: 8px 12px; margin-bottom: 15px;
Â  Â  }
Â  Â  .lock-popup-reason {
Â  Â  Â  font-size: 14px; color: var(--ink); text-align: left;
Â  Â  Â  border: 1px solid #eee; padding: 10px; border-radius: 8px;
Â  Â  }
Â  Â  .lock-popup-reason strong { color: #111827; }
Â  </style>
</head>
<body>
Â  <div class="page">
Â  Â  <h1 id="title">MÃ¤usegruppe Terminal</h1>

Â  Â  <div id="mode-banner" class="mode-banner">EingeschrÃ¤nkter Modus</div>
Â  Â  <div id="locked-banner" class="locked-banner">Terminal gesperrt: Das Terminal ist zurzeit gesperrt.</div>

Â  Â  <div id="notices"></div>

Â  Â  <div class="app-grid" id="app-grid">
Â  Â  Â  <div class="app" id="app-ziel" onclick="window.location.href='https://frederickoeller1207.github.io/ziele/'">
Â  Â  Â  Â  <img src="https://i.supaimg.com/5abf1dba-fcbb-472c-a9bc-3c15894c1bcb.png" alt="Ziel" loading="lazy" decoding="async" width="60" height="60">
Â  Â  Â  Â  <div class="title">Mein Ziel</div><div class="sub">Fortschritt ansehen</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="app" id="app-ausleihe" onclick="openAusleihe()">
Â  Â  Â  Â  <img src="https://i.supaimg.com/dea106e1-18eb-4ae7-b2ea-ca3ded6e63c1.png" alt="Ausleihe" loading="lazy" decoding="async" width="60" height="60">
Â  Â  Â  Â  <div class="title">Spielzeug ausleihen</div><div class="sub">mit PIN</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="app" id="app-checkout" onclick="openCheckout()">
Â  Â  Â  Â  <img src="https://i.supaimg.com/652a2719-c338-4a37-a712-7dd6d56945b5.png" alt="Checkout" loading="lazy" decoding="async" width="60" height="60">
Â  Â  Â  Â  <div class="title">Checkout</div><div class="sub">mit PIN</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="app" id="app-malwettbewerb" onclick="window.location.href='malwettbewerb.html'">
Â  Â  Â  Â  <img src="https://i.supaimg.com/359b3d2b-2cc2-48dd-86b2-4f44ee584857.png" alt="Malwettbewerb" loading="lazy" decoding="async" width="60" height="60">
Â  Â  Â  Â  <div class="title">Malwettbewerb</div><div class="sub">Abgeben & abstimmen</div>
Â  Â  Â  </div>
Â  Â  Â  <div class="app" id="app-briefkasten" onclick="window.location.href='nachrichten.html'">
Â  Â  Â  Â  <img src="https://i.supaimg.com/965bbc7f-a8a5-43f8-a7d1-90ce44c21053.png" alt="Briefkasten" loading="lazy" decoding="async" width="60" height="60">
Â  Â  Â  Â  <div class="title">MausBriefkasten</div><div class="sub">Nachricht schreiben</div>
Â  Â  Â  </div>

      Â  Â  Â  <div class="app" id="app-mouseria" onclick="window.location.href='https://frederickoeller1207.github.io/terminal/mouseria.html'">
Â  Â  Â  Â  <img src="https://i.supaimg.com/40902f5a-3375-45d3-82ff-88373b88d2f1.png" alt="Geschichtenbuch" loading="lazy" decoding="async" width="60" height="60">
Â  Â  Â  Â  <div class="title">Mouseria Geschichten</div><div class="sub">Neuigkeiten & Abenteuer</div>
Â  Â  Â  </div>
      Â  Â  </div>

Â  Â  <div id="menu" class="legacy-menu">
Â  Â  Â  <button onclick="window.location.href='https://frederickoeller1207.github.io/ziele/'">Mein Ziel</button>
Â  Â  Â  <button id="btn-ausleihe">Spielzeug Ausleihe</button>
Â  Â  Â  <button id="btn-checkout">Checkout</button>
Â  Â  </div>

Â  Â  <div id="home-btn">ğŸ  ZurÃ¼ck</div>
Â  Â  <div id="view"></div>
Â  </div>

Â  <div id="lock-overlay"></div>
Â  <div id="toast"></div>

Â  <div id="account-lock-popup" class="lock-popup-overlay" onclick="if(event.target === this) this.style.display='none';">
Â  Â  <div class="lock-popup-content">
Â  Â  Â  <div class="lock-popup-title">Dein Konto wurde vorÃ¼bergehend gesperrt</div>
Â  Â  Â  <div class="lock-popup-reason">
Â  Â  Â  Â  <strong>Grund:</strong> <span id="lock-reason-text"></span>
Â  Â  Â  </div>
Â  Â  Â  <button onclick="document.getElementById('account-lock-popup').style.display='none'" style="margin-top: 15px;">SchlieÃŸen</button>
Â  Â  </div>
Â  </div>

Â  <script type="module">
Â  Â  import { initializeApp as initApp1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
Â  Â  import { getDatabase as getDB1, ref as ref1, get as get1, onValue as onVal1, set as set1 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
Â  Â  import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
Â  Â  import { getDatabase as getDB2, ref as ref2, update as update2, onValue as onVal2, get as get2 } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

Â  Â  const config1={apiKey:"AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",authDomain:"gesamt-dae4e.firebaseapp.com",databaseURL:"https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app",projectId:"gesamt-dae4e",storageBucket:"gesamt-dae4e.appspot.com",messagingSenderId:"844023612743",appId:"1:844023612743:web:0821aa894541f89a7df862"};
Â  Â  const config2={apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",authDomain:"punkte-45c20.firebaseapp.com",databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app",projectId:"punkte-45c20",storageBucket:"punkte-45c20.appspot.com",messagingSenderId:"931713539549",appId:"1:931713539549:web:e348bf38369639f1906a34"};

Â  Â  const app1=initApp1(config1,"app1"); const db1=getDB1(app1);
Â  Â  const app2=initApp2(config2,"app2"); const db2=getDB2(app2);

Â  Â  // HARD LOCK: sofortige Eingabesperre in Capture-Phase
Â  Â  let IS_LOCKED = true; // defensiv bis erste Mode-Antwort kommt
Â  Â  const _block = e => { if (IS_LOCKED) { e.stopImmediatePropagation(); e.preventDefault(); } };
Â  Â  ["click","touchstart","pointerdown","keydown","submit"].forEach(t=>document.addEventListener(t,_block,true));

Â  Â  const view=document.getElementById("view");
Â  Â  const homeBtn=document.getElementById("home-btn");
Â  Â  const noticesBox=document.getElementById('notices');
Â  Â  const modeBanner=document.getElementById('mode-banner');
Â  Â  const lockedBanner=document.getElementById('locked-banner');
Â  Â  const grid=document.getElementById('app-grid');
Â  Â  const lockOverlay=document.getElementById('lock-overlay');
Â  Â  const toast=document.getElementById('toast');
Â  Â  const lockPopup = document.getElementById('account-lock-popup');
Â  Â  const lockReasonText = document.getElementById('lock-reason-text');


Â  Â  let IS_HOME=true;
Â  Â  let latestNotices=[];
Â  Â  let MODE="green";

Â  Â  function showToast(msg, ms=3500){
Â  Â  Â  toast.textContent=msg; toast.style.display='block';
Â  Â  Â  clearTimeout(showToast._t); showToast._t=setTimeout(()=>{ toast.style.display='none'; }, ms);
Â  Â  }

Â  Â  function showAccountLocked(grund){
Â  Â  Â  lockReasonText.textContent = grund || 'Kein Grund angegeben.';
Â  Â  Â  lockPopup.style.display = 'flex';
Â  Â  }

Â  Â  const resetView=()=>{
Â  Â  Â  view.innerHTML=""; homeBtn.style.display="none";
Â  Â  Â  document.getElementById("title").textContent="MÃ¤usegruppe Terminal";
Â  Â  Â  IS_HOME=true; applyModeToUI(); window.scrollTo({top:0,behavior:'instant'});
Â  Â  };
Â  Â  const openView=(title)=>{
Â  Â  Â  view.innerHTML=""; homeBtn.style.display="flex";
Â  Â  Â  document.getElementById("title").textContent=title;
Â  Â  Â  grid.style.display='none'; IS_HOME=false; noticesBox.style.display='none';
Â  Â  Â  modeBanner.style.display='none'; lockedBanner.style.display='none'; lockOverlay.style.display='none';
Â  Â  };
Â  Â  homeBtn.onclick=()=>{ resetView(); };

Â  Â  function colorToClass(c){ const m={blue:'n-blue',red:'n-red',green:'n-green',orange:'n-orange',purple:'n-purple',black:'n-black',grey:'n-gray',gray:'n-gray'}; return m[(c||'').toLowerCase()]||'n-blue'; }
Â  Â  function parseISO(s){ const d=new Date(s); return isNaN(d.getTime())?null:d; }
Â  Â  function renderNoticesList(items){
Â  Â  Â  latestNotices=items||[];
Â  Â  Â  if(!IS_HOME || !latestNotices.length){ noticesBox.style.display='none'; return; }
Â  Â  Â  noticesBox.style.display='block';
Â  Â  Â  noticesBox.innerHTML=latestNotices.map(n=>{
Â  Â  Â  Â  const cls=colorToClass(n.color); const title=(n.title&&n.title.trim())?n.title.trim():'Nachricht'; const text=(n.text||'');
Â  Â  Â  Â  return `<div class="notice ${cls}"><h3>${title}</h3><p>${text}</p></div>`;
Â  Â  Â  }).join('');
Â  Â  }
Â  Â  function subscribeNotices(){
Â  Â  Â  onVal1(ref1(db1,'kurznachrichten'),snap=>{
Â  Â  Â  Â  const now=new Date(); const list=[];
Â  Â  Â  Â  if(snap.exists()){
Â  Â  Â  Â  Â  snap.forEach(ch=>{
Â  Â  Â  Â  Â  Â  const v=ch.val()||{}; const start=parseISO(v.startISO); const end=parseISO(v.endISO);
Â  Â  Â  Â  Â  Â  if(!start||!end) return; if(now>=start && now<=end){
Â  Â  Â  Â  Â  Â  Â  list.push({id:ch.key,title:v.title||'',text:v.text||'',color:v.color||'blue',start, end, createdAt:Number(v.createdAt||0)});
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0) || (b.start - a.start));
Â  Â  Â  Â  renderNoticesList(list);
Â  Â  Â  });
Â  Â  }

Â  Â  function subscribeMode(){
Â  Â  Â  onVal1(ref1(db1,"systemmode/state"), snap=>{
Â  Â  Â  Â  const m = snap.exists() ? (snap.val().value||"green") : "green";
Â  Â  Â  Â  MODE = m;
Â  Â  Â  Â  if (m === "red"){
Â  Â  Â  Â  Â  IS_LOCKED = true;
Â  Â  Â  Â  Â  view.innerHTML="";
Â  Â  Â  Â  Â  lockedBanner.style.display='block';
Â  Â  Â  Â  Â  lockOverlay.style.display='block';
Â  Â  Â  Â  Â  grid.style.display='none';
Â  Â  Â  Â  Â  noticesBox.style.display='none';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  IS_LOCKED = false;
Â  Â  Â  Â  Â  lockedBanner.style.display='none';
Â  Â  Â  Â  Â  lockOverlay.style.display='none';
Â  Â  Â  Â  Â  resetView();
Â  Â  Â  Â  }
Â  Â  Â  Â  applyModeToUI();
Â  Â  Â  });
Â  Â  }

Â  Â  function applyModeToUI(){
Â  Â  Â  if(IS_LOCKED){
Â  Â  Â  Â  grid.style.display='none'; noticesBox.style.display='none'; return;
Â  Â  Â  }
Â  Â  Â  if(!IS_HOME) return;
Â  Â  Â  if(MODE==="green"){
Â  Â  Â  Â  modeBanner.style.display='none'; grid.style.display='grid'; renderNoticesList(latestNotices);
Â  Â  Â  Â  // alle Apps sichtbar
Â  Â  Â  Â  ["app-ziel","app-ausleihe","app-checkout","app-malwettbewerb","app-briefkasten", "app-mouseria"].forEach(id=>{
Â  Â  Â  Â  Â  const el=document.getElementById(id); if(el) el.style.display='flex';
Â  Â  Â  Â  });
Â  Â  Â  } else if(MODE==="yellow"){
Â  Â  Â  Â  modeBanner.style.display='block'; grid.style.display='grid';
Â  Â  Â  Â  // nur Checkout + Ziel
Â  Â  Â  Â  ["app-checkout","app-ziel", "app-mouseria"].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='flex'; });
Â  Â  Â  Â  ["app-ausleihe","app-malwettbewerb","app-briefkasten"].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='none'; });
Â  Â  Â  Â  noticesBox.style.display='none';
Â  Â  Â  }
Â  Â  Â  // rot wird oben durch IS_LOCKED behandelt
Â  Â  }

Â  Â  document.getElementById("btn-ausleihe").onclick = ()=>openAusleihe();
Â  Â  window.openAusleihe = ()=>{
Â  Â  Â  if(IS_LOCKED || MODE!=="green"){ showToast("EingeschrÃ¤nkter Modus: Diese Funktion ist derzeit deaktiviert."); return; }
Â  Â  Â  openView("Spielzeug Ausleihe");
Â  Â  Â  onVal1(ref1(db1,"kinder"), snapshot=>{
Â  Â  Â  Â  view.innerHTML="";
Â  Â  Â  Â  snapshot.forEach(childSnap=>{
Â  Â  Â  Â  Â  const name=childSnap.key; const btn=document.createElement("button"); btn.textContent=name;
Â  Â  Â  Â  Â  btn.onclick=()=>checkSicherheitscode(name,()=>ausleihen(name)); view.appendChild(btn);
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  };
Â  Â  function eingabeMitZahl(title,callback){
Â  Â  Â  openView(title);
Â  Â  Â  const input=document.createElement("input"); input.type="number"; input.inputMode="numeric"; input.autofocus=true;
Â  Â  Â  const btn=document.createElement("button"); btn.textContent="OK";
Â  Â  Â  btn.onclick=()=>{ const val=input.value.trim(); if(val) callback(val); };
Â  Â  Â  view.appendChild(input); view.appendChild(btn); input.focus();
Â  Â  }
Â  Â  async function ausleihen(name){
Â  Â  Â  if(IS_LOCKED || MODE!=="green"){ showToast("EingeschrÃ¤nkter Modus: Diese Funktion ist derzeit deaktiviert."); return; }
Â  Â  Â  const ausleiheSnap=await get1(ref1(db1,`ausleihen/${name}`));
Â  Â  Â  if(ausleiheSnap.exists() && ausleiheSnap.val().bestÃ¤tigt===false){ showToast("Bitte gib das ausgeliehene Spielzeug zurÃ¼ck."); return; }
Â  Â  Â  frageSpielzeugnummer(name, async (nummer)=>{
Â  Â  Â  Â  const spielzeugeSnap=await get1(ref1(db1,"spielzeuge")); const spielzeuge=spielzeugeSnap.exists()?spielzeugeSnap.val():{};
Â  Â  Â  Â  if(spielzeuge[nummer]){
Â  Â  Â  Â  Â  await set1(ref1(db1,`ausleihen/${name}`),{spielzeug:spielzeuge[nummer],nummer,zeit:new Date().toISOString(),bestÃ¤tigt:false});
Â  Â  Â  Â  Â  const popup=document.createElement("div");
Â  Â  Â  Â  Â  popup.textContent=`${spielzeuge[nummer]} erfolgreich ausgeliehen.`;
Â  Â  Â  Â  Â  popup.style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:#000;padding:16px 22px;border-radius:10px;font-size:16px;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:9999;text-align:center;";
Â  Â  Â  Â  Â  document.body.appendChild(popup);
Â  Â  Â  Â  Â  setTimeout(()=>{ popup.remove(); resetView(); },3000);
Â  Â  Â  Â  } else { showToast("UngÃ¼ltige Nummer."); }
Â  Â  Â  });
Â  Â  }
Â  Â  function frageSpielzeugnummer(name,cb){ eingabeMitZahl(`${name}, gib bitte die Spielzeugnummer ein:`, cb); }

Â  Â  document.getElementById("btn-checkout").onclick = ()=>openCheckout();
Â  Â  window.openCheckout = ()=>{
Â  Â  Â  if(IS_LOCKED || MODE==="red"){ showToast("Terminal gesperrt."); return; }
Â  Â  Â  openView("Checkout");
Â  Â  Â  onVal1(ref1(db1,"kinder"), snapshot=>{
Â  Â  Â  Â  view.innerHTML="";
Â  Â  Â  Â  snapshot.forEach(childSnap=>{
Â  Â  Â  Â  Â  const name=childSnap.key; const link=childSnap.val().link;
Â  Â  Â  Â  Â  const btn=document.createElement("button"); btn.textContent=name;
Â  Â  Â  Â  Â  btn.onclick=()=>checkSicherheitscode(name,()=>{ if(link) window.location.href=link; else showToast("Kein Link hinterlegt."); });
Â  Â  Â  Â  Â  view.appendChild(btn);
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  };

Â  Â  async function checkSicherheitscode(name,callback){
Â  Â  Â  if(IS_LOCKED || MODE==="red"){ showToast("Terminal gesperrt."); return; }

Â  Â  Â  const snap=await get1(ref1(db1,`kinder/${name}`));
Â  Â  Â  if(!snap.exists()){ showToast("Konto nicht gefunden."); return; }
Â  Â  Â  const data = snap.val() || {};

Â  Â  Â  // PRÃœFUNG: Ist das Konto gesperrt?
Â  Â  Â  if (data.gesperrt === true) {
Â  Â  Â  Â  Â  showAccountLocked(data.sperrGrund);
Â  Â  Â  Â  Â  return; // Abbruch, wenn gesperrt
Â  Â  Â  }

Â  Â  Â  const code=data.code;
Â  Â  Â  if(!code){ showToast("Kein Sicherheitscode hinterlegt."); return; }

Â  Â  Â  eingabeMitZahl(`Bitte Sicherheitscode fÃ¼r ${name} eingeben:`, (eingabe)=>{Â 
Â  Â  Â  Â  Â  if(eingabe===code) callback();Â 
Â  Â  Â  Â  Â  else showToast("Falscher Code.");Â 
Â  Â  Â  });
Â  Â  }

Â  Â  (function handleDeepLinks(){
Â  Â  Â  const params=new URLSearchParams(location.search);
Â  Â  Â  if(!params.has("action")) return;
Â  Â  Â  const act=params.get("action");
Â  Â  Â  onVal1(ref1(db1,"systemmode/state"), snap=>{
Â  Â  Â  Â  const m=snap.exists()?(snap.val().value||"green"):"green";
Â  Â  Â  Â  MODE=m;
Â  Â  Â  Â  if(m==="red"){
Â  Â  Â  Â  Â  IS_LOCKED = true;
Â  Â  Â  Â  Â  showToast("Die Funktion ist im gesperrten Modus deaktiviert.", 3500);
Â  Â  Â  Â  Â  resetView();
Â  Â  Â  Â  Â  lockedBanner.style.display='block';
Â  Â  Â  Â  Â  lockOverlay.style.display='block';
Â  Â  Â  Â  } else if(m==="yellow"){
Â  Â  Â  Â  Â  if(act==="checkout"){ openCheckout(); } else { resetView(); showToast("EingeschrÃ¤nkter Modus: Nur Checkout und Mein Ziel sind verfÃ¼gbar."); }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  if(act==="checkout"){ openCheckout(); }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  })();

Â  Â  function init(){
Â  Â  Â  resetView(); subscribeNotices(); subscribeMode();
Â  Â  }
Â  Â  init();
Â  </script>

Â  <script>
Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  navigator.serviceWorker.register('/sw.js', { scope: '/' }).catch(console.warn);
Â  Â  }
Â  </script>
</body>
</html>

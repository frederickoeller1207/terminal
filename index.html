<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Mäusegruppe Terminal</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getDatabase, ref, get, onValue, set } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQaNKUa-RKvUcwlPpWnEyKxcVjYV6cZuU",
      authDomain: "gesamt-dae4e.firebaseapp.com",
      databaseURL: "https://gesamt-dae4e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "gesamt-dae4e",
      storageBucket: "gesamt-dae4e.appspot.com",
      messagingSenderId: "844023612743",
      appId: "1:844023612743:web:0821aa894541f89a7df862"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const view = document.getElementById("view");
    const title = document.getElementById("title");

    document.getElementById("btn-ausleihe").onclick = loadAusleihe;
    document.getElementById("btn-checkout").onclick = loadCheckout;

    function resetView() {
      title.textContent = "Mäusegruppe Terminal";
      view.innerHTML = "";
    }

    function loadAusleihe() {
      resetView();
      title.textContent = "Spielzeug Ausleihe";

      onValue(ref(db, "kinder"), (snapshot) => {
        view.innerHTML = "";
        snapshot.forEach(childSnap => {
          const name = childSnap.key;
          const btn = document.createElement("button");
          btn.textContent = name;
          btn.onclick = () => ausleihen(name);
          view.appendChild(btn);
        });
      });
    }

    async function ausleihen(name) {
      const ausleiheSnap = await get(ref(db, `ausleihen/${name}`));
      if (ausleiheSnap.exists() && ausleiheSnap.val().bestätigt === false) {
        alert("Bitte gib das ausgeliehene Spielzeug zurück, bevor du ein neues ausleihst.");
        return;
      }

      const nummer = prompt(`${name}, gib bitte die Spielzeugnummer ein:`);
      if (!nummer) return;

      const spielzeugeSnap = await get(ref(db, "spielzeuge"));
      const spielzeuge = spielzeugeSnap.exists() ? spielzeugeSnap.val() : {};

      if (spielzeuge[nummer]) {
        await set(ref(db, `ausleihen/${name}`), {
          spielzeug: spielzeuge[nummer],
          nummer: nummer,
          zeit: new Date().toISOString(),
          bestätigt: false
        });

        const msg = document.createElement("div");
        msg.textContent = `${spielzeuge[nummer]} erfolgreich ausgeliehen.`;
        msg.style = "margin-top: 20px; font-weight: bold;";
        view.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      } else {
        alert("Ungültige Nummer.");
      }
    }

    function loadCheckout() {
      resetView();
      title.textContent = "Checkout";

      onValue(ref(db, "kinder"), (snapshot) => {
        view.innerHTML = "";
        snapshot.forEach(childSnap => {
          const name = childSnap.key;
          const link = childSnap.val().link;

          const btn = document.createElement("button");
          btn.textContent = name;
          btn.onclick = () => {
            if (link) {
              window.location.href = link;
            } else {
              alert("Kein Link hinterlegt.");
            }
          };
          view.appendChild(btn);
        });
      });
    }
  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { margin-bottom: 20px; }
    .menu { margin-bottom: 20px; }
    button {
      display: block;
      margin: 8px 0;
      padding: 12px 20px;
      font-size: 18px;
      width: 100%;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <h1 id="title">Mäusegruppe Terminal</h1>
  <div class="menu">
    <button id="btn-ausleihe">Spielzeug Ausleihe</button>
    <button id="btn-checkout">Checkout</button>
  </div>
  <div id="view"></div>
</body>
</html>
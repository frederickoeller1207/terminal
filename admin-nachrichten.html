<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MausBriefkasten – Admin</title>
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f5f7fb;--ink:#1b1b1f;--card:#fff;--muted:#666;--accent:#007aff}
  *{box-sizing:border-box}
  body{font-family:'SF Pro Display',sans-serif;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 14px 40px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  h1{font-size:24px;margin:0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input{font-family:inherit;font-size:14px;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:14px}
  .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:13px;color:var(--muted)}
  .badge{display:inline-block;background:#eef2ff;color:#2c3e7d;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:800}
  .msg{white-space:pre-wrap;margin-top:8px;font-size:16px;line-height:1.5}
  .count{font-size:13px;color:var(--muted)}
</style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
  import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

  const appPunkte = initializeApp({
    apiKey:"AIzaSyAdPN2duh89Fx5rmYlFshdf0juhYNX_7fg",
    databaseURL:"https://punkte-45c20-default-rtdb.europe-west1.firebasedatabase.app"
  },"punkteAdmin");
  const db = getDatabase(appPunkte);

  const $=(q)=>document.querySelector(q);
  const listEl = $("#list");
  const filterTopic = $("#filterTopic");
  const searchInput = $("#search");

  let allMsgs = [];

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString('de-DE', { dateStyle:'short', timeStyle:'short' });
    }catch{ return iso||""; }
  }

  function render(){
    const topic = filterTopic.value;
    const q = (searchInput.value||"").toLowerCase();
    listEl.innerHTML = "";

    const rows = allMsgs
      .filter(m => topic==="" || m.thema===topic)
      .filter(m => !q || m.absender.toLowerCase().includes(q) || m.text.toLowerCase().includes(q) || m.thema.toLowerCase().includes(q));

    $("#count").textContent = `${rows.length} Nachricht(en)`;

    rows.forEach(m=>{
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="badge">${m.thema}</span>
            <span class="meta">von <strong>${m.absender}</strong> • ${fmtDate(m.zeit)}</span>
          </div>
        </div>
        <div class="msg">${escapeHtml(m.text)}</div>
      `;
      listEl.appendChild(card);
    });
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }

  // Laden, neueste oben
  onValue(query(ref(db,"briefkasten/nachrichten"), limitToLast(1000)), snap=>{
    const val = snap.val()||{};
    const arr = Object.keys(val).map(k=>({ id:k, ...val[k] }));
    arr.sort((a,b)=> (b.zeit||"").localeCompare(a.zeit||""));
    allMsgs = arr;
    // Themenliste bauen
    const topics = Array.from(new Set(arr.map(x=>x.thema))).sort((a,b)=>a.localeCompare(b,'de',{sensitivity:'base'}));
    const cur = filterTopic.value;
    filterTopic.innerHTML = `<option value="">Alle Themen</option>` + topics.map(t=>`<option>${t}</option>`).join("");
    filterTopic.value = cur || "";
    render();
  });

  filterTopic.addEventListener("change", render);
  searchInput.addEventListener("input", render);
</script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>MausBriefkasten – Admin</h1>
      <div class="row">
        <select id="filterTopic">
          <option value="">Alle Themen</option>
        </select>
        <input id="search" type="search" placeholder="Suche in Absender, Thema, Nachricht">
      </div>
    </header>
    <div class="count" id="count">0 Nachricht(en)</div>
    <div id="list" class="list"></div>
  </div>
</body>
</html>